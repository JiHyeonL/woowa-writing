# Server-Sent-Eventë¡œ íŒ€ í”„ë¡œì íŠ¸ì— ë™ê¸°í™” ì ìš©í•˜ê¸°

ì•ˆë…•í•˜ì„¸ìš”, ìš°ì•„í•œí…Œí¬ì½”ìŠ¤ 6ê¸° ë ˆëª¨ë„¤ ì…ë‹ˆë‹¤.  
í˜ì–´ í”„ë¡œê·¸ë˜ë°ì„ ë•ëŠ” ì„œë¹„ìŠ¤ì¸ â€œì½”ë”©í•´ë“€ì˜¤â€ í”„ë¡œì íŠ¸ì— ì°¸ì—¬í•˜ë©° ë™ê¸°í™”ë¥¼ ì ìš©í•´ ë³´ì•˜ëŠ”ë°ìš”,  
SSEë¥¼ ì ìš©í•œ ë°°ê²½ë¶€í„° êµ¬í˜„ ë°©ë²•ê¹Œì§€ ì•Œì•„ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.  

## ë™ê¸°í™”ê°€ í•„ìš”í•´
ì €í¬ ì„œë¹„ìŠ¤ì—ì„œ â€œí˜ì–´ë£¸ ë§Œë“¤ê¸°" ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ í˜ì–´ í”„ë¡œê·¸ë˜ë°ì„ í•  ìˆ˜ ìˆëŠ” ê³µê°„ì„ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.  
![img.png](img.png)
ì´ ê³µê°„ì´ â€œí˜ì–´ë£¸" ì…ë‹ˆë‹¤.  
í•´ë‹¹ í˜ì–´ë£¸ì— *í•œ ëª…ì˜ ì‚¬ìš©ì*ë§Œ ì ‘ì†í•˜ê³  ìˆë‹¤ë©´ í° ë¬¸ì œê°€ ë°œìƒí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.  
ê·¸ëŸ¬ë‚˜ í˜ì–´ë£¸ì— *ì—¬ëŸ¬ ì‚¬ìš©ì*ê°€ ì ‘ì†í•˜ê²Œ ëœë‹¤ë©´ í•œ ê°€ì§€ ê³ ë ¤í•´ì•¼ í•  ì ì´ ìƒê¹ë‹ˆë‹¤.  
ë°”ë¡œ `íƒ€ì´ë¨¸ ë™ê¸°í™”` ì…ë‹ˆë‹¤.  
ë§Œì•½ íƒ€ì´ë¨¸ê°€ ë™ê¸°í™” ë˜ì§€ ì•ŠëŠ”ë‹¤ë©´ ì–´ë–¤ ìƒí™©ì´ ë°œìƒí• ê¹Œìš”?  
![img_4.png](img_4.png)
> ~ ë ˆëª¨ë„¤ì™€ ì‚¬ê³¼ê°€ í˜ì–´í”„ë¡œê·¸ë˜ë°ì„ ì§„í–‰í•˜ê³  ìˆë‹¤~  
ğŸ‹ : í˜ì–´ë£¸ ë§Œë“¤ì—ˆì–´. ì´ì œ íƒ€ì´ë¨¸ ì‹œì‘í• ê²Œ!  
ğŸ : íƒ€ì´ë¨¸ë¥¼ ë‚´ ë…¸íŠ¸ë¶ìœ¼ë¡œë„ í™•ì¸í•˜ê³  ì‹¶ìœ¼ë‹ˆê¹Œ ë ˆëª¨ë„¤ê°€ ë§Œë“  í˜ì–´ë£¸ì— ì ‘ì†í•´ì•¼ê² ë‹¤. ì–´, ê·¸ëŸ°ë° íƒ€ì´ë¨¸ í™”ë©´ì´ ë ˆëª¨ë„¤ì™€ ë‹¤ë¥´ë„¤?  

ìœ„ì˜ ì‚¬ì§„ì„ ë°”íƒ•ìœ¼ë¡œ ë ˆëª¨ë„¤(ì™¼ìª½ íƒ€ì´ë¨¸)ì™€ ì‚¬ê³¼(ì˜¤ë¥¸ìª½ íƒ€ì´ë¨¸)ì˜ í™”ë©´ì„ ë¹„êµí•´ ë´…ì‹œë‹¤.  
ë ˆëª¨ë„¤ì˜ íƒ€ì´ë¨¸ëŠ” ì‹¤í–‰ë˜ê³  ìˆì§€ë§Œ, ì‚¬ê³¼ì˜ íƒ€ì´ë¨¸ëŠ” ì¤‘ì§€ ìƒíƒœì´ë‹¤.  
ë ˆëª¨ë„¤ì˜ íƒ€ì´ë¨¸ëŠ” ì‹¤í–‰ ì¤‘ì´ê¸° ë•Œë¬¸ì— `ì¼ì‹œì •ì§€` ë²„íŠ¼ì´ í™œì„±í™” ë˜ì–´ìˆê³ , ì‚¬ê³¼ì˜ íƒ€ì´ë¨¸ëŠ” ì¤‘ì§€ ìƒíƒœì´ê¸° ë•Œë¬¸ì— `ì‹¤í–‰` ë²„íŠ¼ì´ í™œì„±í™” ë˜ì–´ìˆë‹¤.  

ì´ë ‡ê²Œ ë‹¤ì¤‘ ì‚¬ìš©ìê°€ ì‹¤ì‹œê°„ìœ¼ë¡œ ë³€í™”í•˜ëŠ” *ë™ì¼í•œ í™”ë©´*ì„ ë°”ë¼ë³´ì•„ì•¼ í•  ë•Œ, `ë™ê¸°í™”` ê°€ í•„ìš”í•©ë‹ˆë‹¤.  

## ì›¹ì†Œì¼“ vs SSE
ë™ê¸°í™”ë¥¼ í•˜ë ¤ë©´ ëª¨ë“  ì‚¬ìš©ìì—ê²Œ *ì‹¤ì‹œê°„ìœ¼ë¡œ ê°™ì€ ë°ì´í„°*ë¥¼ ì „ì†¡í•´ì•¼ í•©ë‹ˆë‹¤.  
ê°€ì¥ ë§ì´ ì“°ì´ëŠ” **ì‹¤ì‹œê°„ í†µì‹ ** ê¸°ìˆ ë¡œëŠ” `ì›¹ì†Œì¼“`ê³¼ `SSE`ê°€ ìˆìŠµë‹ˆë‹¤.  
ë‘ ê¸°ìˆ ì„ ë¹„êµí•˜ë©° ì €í¬ ì„œë¹„ìŠ¤ì— ì–´ë–¤ ë°©ì‹ì´ ë” ì ì ˆí• ì§€ ì°¾ì•„ë´…ì‹œë‹¤.  

### SSE (Server-Sent-Event)
SSEëŠ” **http í”„ë¡œí† ì½œ** ê¸°ë°˜ ì‹¤ì‹œê°„ í†µì‹  ë°©ë²•ì…ë‹ˆë‹¤.  
SSEì˜ íŠ¹ì§•ì€ **ë‹¨ë°©í–¥ í†µì‹ **ì´ë¼ëŠ” ì ì¸ë°ìš”, `ì„œë²„ì—ì„œ í´ë¼ì´ì–¸íŠ¸ ë°©í–¥`ìœ¼ë¡œë§Œ ë°ì´í„°ë¥¼ ì „ì†¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.  

í´ë¼ì´ì–¸íŠ¸ê°€ SSE í†µì‹ ì„ ì‹œì‘í•˜ê³  ì‹¶ë‹¤ëŠ” ìš”ì²­ì„ ë³´ë‚´ë©´,  
ì„œë²„ëŠ” SSE `ì»¤ë„¥ì…˜` ì„ ìƒì„±í•©ë‹ˆë‹¤.  
ì´ `ì»¤ë„¥ì…˜`ìœ¼ë¡œ ì„œë²„ê°€ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ë°ì´í„°ë¥¼ ì „ì†¡í•˜ê²Œ ë©ë‹ˆë‹¤.  
(ë¬¼ë¡  ì»¤ë„¥ì…˜ì´ ë‹«íˆë©´ í•´ë‹¹ ì»¤ë„¥ì…˜ìœ¼ë¡œ ë”ì´ìƒ ë°ì´í„°ë¥¼ ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.)  

![img_5.png](img_5.png)
ì´ë¯¸ì§€ ì¶œì²˜:  https://bigboxcode.com/server-sent-events-sse

http í”„ë¡œí† ì½œ íŠ¹ì„±ìƒ `ìš”ì²­-ì‘ë‹µ ì£¼ê¸°`ê°€ ë°˜ë³µë˜ì–´ì•¼ í• í…ë°, ì–´ë–»ê²Œ ìš”ì²­ì´ ì—†ëŠ”ë°ë„ ì„œë²„ê°€ ì§€ì†ì ìœ¼ë¡œ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ë°ì´í„°ë¥¼ ì „ì†¡í•  ìˆ˜ ìˆì„ê¹Œìš”?
ì •ë‹µì€ ì„œë²„ê°€ ë³´ë‚´ëŠ” ë°ì´í„°ê°€ *í•˜ë‚˜ì˜ ì‘ë‹µì´ ì•„ë‹Œ*, chunk ë‹¨ìœ„ì˜ `ìŠ¤íŠ¸ë¦¼`ì´ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

ê°„ë‹¨í•˜ê²Œ ë§í•˜ìë©´
> ì‘ë‹µ ë°ì´í„°ë¥¼ ì „ì†¡í• ê±´ë°, ë°ì´í„°ë¥¼ ì‘ì€ ë‹¨ìœ„ë¡œ ìª¼ê°œì„œ ê³„ì† ë³´ë‚¼ê±°ì•¼. ë°ì´í„°ë¥¼ ë‹¤ ë³´ëƒˆë‹¤ê³  ë‚´ê°€ ë§í•˜ê¸° ì „ê¹Œì§€ ì‘ë‹µì„ ì™„ë£Œ ì²˜ë¦¬í•˜ì§€ë§ˆ!

ë¼ëŠ” ì˜ë¯¸ì…ë‹ˆë‹¤.
ê²°êµ­ í•˜ë‚˜ì˜ ìš”ì²­ì— í•˜ë‚˜ì˜ ì‘ë‹µì´ë¼ëŠ” íŠ¹ì„±ì€ ìœ ì§€í•œ ì±„, ë°ì´í„°ë¥¼ ì§€ì†ì ìœ¼ë¡œ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì „ì†¡í•  ìˆ˜ ìˆëŠ” ê²ƒì´ì£ .
ì»¤ë„¥ì…˜ì´ ëŠì–´ì§ˆ ë•Œê¹Œì§€ í´ë¼ì´ì–¸íŠ¸ëŠ” ì„œë²„ê°€ ë³´ë‚´ëŠ” ë°ì´í„°ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ëŸ¬í•œ íŠ¹ì§• ë•Œë¬¸ì— SSEëŠ” **ì•Œë¦¼** ì‹œìŠ¤í…œì„ êµ¬ì¶•í•  ë•Œ ì£¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.

### ì›¹ì†Œì¼“
ì›¹ì†Œì¼“ì€ `ì›¹ì†Œì¼“ í”„ë¡œí† ì½œ` ê¸°ë°˜ ì‹¤ì‹œê°„ í†µì‹ ì…ë‹ˆë‹¤. SSEì²˜ëŸ¼ http í”„ë¡œí† ì½œì„ ì‚¬ìš©í•˜ì§€ ì•Šê³ , ì›¹ì†Œì¼“ ì „ìš©  í”„ë¡œí† ì½œì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
SSEì™€ ì°¨ë³„í™”ëœ ë˜ ë‹¤ë¥¸ íŠ¹ì§•ì€ `ì–‘ë°©í–¥ í†µì‹ `ì„ í•œë‹¤ëŠ” ì ì…ë‹ˆë‹¤.  
ì–‘ë°©í–¥ í†µì‹ ì´ ê°€ëŠ¥í•˜ë‹¤ëŠ” ê²ƒì€, **í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ê°€ ë™ì‹œ**ì— ë°ì´í„°ë¥¼ ì£¼ê³ ë°›ì„ ìˆ˜ ìˆë‹¤ëŠ” ëœ»ì…ë‹ˆë‹¤.
http í”„ë¡œí† ì½œì—ì„œëŠ” í´ë¼ì´ì–¸íŠ¸ì˜ ìš”ì²­ì´ ì˜¬ ë•Œê¹Œì§€ ê¸°ë‹¤ë¦° ë’¤ ì‘ë‹µì„ ë³´ë‚´ê±°ë‚˜, ì„œë²„ì—ì„œ í´ë¼ì´ì–¸íŠ¸ ë°©í–¥(ë‹¨ë°©í–¥)ìœ¼ë¡œë§Œ ë°ì´í„°ë¥¼ ì „ì†¡í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.

ê·¸ëŸ¬ë‚˜ ì›¹ì†Œì¼“ì€ ì„œë²„ê°€ í´ë¼ì´ì–¸íŠ¸ì˜ ìš”ì²­ ì—†ì´ ì‘ë‹µí•  ìˆ˜ë„ ìˆê³ , í´ë¼ì´ì–¸íŠ¸ê°€ ì‘ë‹µ ì—†ì´ ì—¬ëŸ¬ë²ˆ ìš”ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
ì‚¬ì‹¤ìƒ `í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„`, `ìš”ì²­ê³¼ ì‘ë‹µ`ì´ ì„œë¡œ êµ¬ë³„ë˜ì§€ ì•ŠëŠ” *ë™ë“±í•œ ìƒíƒœ*ê°€ ë˜ëŠ” ê²ƒì´ì£ .

ê·¸ë˜ì„œ ì›¹ì†Œì¼“ì€ `ì±„íŒ…` ì• í”Œë¦¬ì¼€ì´ì…˜ì— ì£¼ë¡œ ì“°ì…ë‹ˆë‹¤.

## ê·¸ë˜ì„œ ì–´ë–¤ ê¸°ìˆ ì„ ì‚¬ìš©í• ê¹Œ?
ì§€ê¸ˆê¹Œì§€ SSEì™€ ì›¹ì†Œì¼“ì— ëŒ€í•´ ì•Œì•„ë³´ì•˜ìŠµë‹ˆë‹¤.
ì´ì œ ì–´ë–¤ ë°©ì‹ì„ ì„ íƒí• ì§€ ê²°ì •í•  ì‹œê°„ì´ ë˜ì—ˆë„¤ìš”.

íƒ€ì´ë¨¸ë¥¼ ì‹¤í–‰í•˜ê³  ì¤‘ì§€í•˜ë ¤ë©´, ì–´ë–¤ ì •ë³´ê°€ í•„ìš”í• ê¹Œìš”?
- íƒ€ì´ë¨¸ ì‹œì‘ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´, íƒ€ì´ë¨¸ ì‹œê°„ì´ 1ì´ˆë§ˆë‹¤ ì¤„ì–´ë“ ë‹¤.
- íƒ€ì´ë¨¸ ì¼ì‹œì •ì§€ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´, íƒ€ì´ë¨¸ ì‹œê°„ì´ ìœ ì§€ëœë‹¤.

íƒ€ì´ë¨¸ ì‹œì‘ ìš”ì²­ì„ ë³´ëƒˆì„ ë•Œ, 1ì´ˆì”© ì¤„ì–´ë“œëŠ” ì‹œê°„ ì •ë³´ë§Œ í•„ìš”í•˜ë‹¤ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
íƒ€ì´ë¨¸ ì‹œê°„ì„ 1ì´ˆë§ˆë‹¤ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì „ì†¡í•´ ì£¼ë©´ ë˜ê² ë„¤ìš”.

ê·¸ëŸ¼ ì—¬ê¸°ì„œ ë– ì˜¤ë¥´ëŠ” ê¸°ìˆ ì´ í•˜ë‚˜ ìˆì„ í…ë°ìš”, ë°”ë¡œ SSE ì…ë‹ˆë‹¤.  
ì›¹ì†Œì¼“ì´ ì œê³µí•˜ëŠ” ì–‘ë°©í–¥ í†µì‹ ì˜ ì´ì ì´ íƒ€ì´ë¨¸ ë™ê¸°í™”ì— í•„ìˆ˜ì ì´ì§€ ì•Šê¸° ë•Œë¬¸ì— SSEë¥¼ ì‚¬ìš©í•˜ëŠ”ê²Œ ë” ì ì ˆí•´ ë³´ì…ë‹ˆë‹¤.

ì´ì œ ë³¸ê²©ì ìœ¼ë¡œ êµ¬í˜„ì„ ì‹œì‘í•´ ë´…ì‹œë‹¤.

## íƒ€ì´ë¨¸ ì‹œê°„ ë™ê¸°í™”í•˜ê¸°
â€œì½”ë”©í•´ë“€ì˜¤â€ëŠ” `ìŠ¤í”„ë§ ë¶€íŠ¸`ë¥¼ ì‚¬ìš©í•˜ê³  ìˆê¸° ë•Œë¬¸ì— `ìŠ¤í”„ë§ ë¶€íŠ¸`ë¥¼ ê¸°ë°˜ìœ¼ë¡œ SSEë¥¼ êµ¬í˜„í•´ ë³´ê² ìŠµë‹ˆë‹¤.
### 1) ì»¤ë„¥ì…˜ ìƒì„±
ë¨¼ì € í˜ì–´ë£¸ì— ì ‘ì†í•œ í´ë¼ì´ì–¸íŠ¸ì™€ SSE ì»¤ë„¥ì…˜ì„ ë§ºì–´ì•¼ í•©ë‹ˆë‹¤.

``` java
@RestController
public class SseController implements SseDocs {


   private final SseService sseService;


   @GetMapping("/{key}/connect")
   public ResponseEntity<SseEmitter> createConnection(@PathVariable("key") final String key) {
       final SseEmitter sseEmitter = sseService.connect(key);


       return ResponseEntity.ok(sseEmitter);
   }
```
ì»¨íŠ¸ë¡¤ëŸ¬ì— SSE ì»¤ë„¥ì…˜ ìƒì„± ìš”ì²­ apië¥¼ ì¶”ê°€í•´ ì¤ì‹œë‹¤.
ì°¸ê³ ë¡œ ì—”íŠ¸í¬ì¸íŠ¸ì— ìˆëŠ” `{key}`ëŠ” í˜ì–´ë£¸ì„ ì‹ë³„í•  ìˆ˜ ìˆëŠ” ì½”ë“œì…ë‹ˆë‹¤.

`sseService.connect()` ê°€ ì–´ë–»ê²Œ êµ¬í˜„ë˜ì–´ ìˆëŠ”ì§€ ìì„¸íˆ ì‚´í´ë´…ì‹œë‹¤.

``` java
@Service
public class SseService {


   private final EventStreamsRegistry eventStreamsRegistry;


   public SseEmitter connect(final String key) {
       final SseEmitter emitter = eventStreamsRegistry.register(key);
       return emitter;
   }
```
eventStreamRegistryì—ì„œ key(í˜ì–´ë£¸ ì‹ë³„ì)ì— í•´ë‹¹í•˜ëŠ” SseEmitterë¥¼ ìƒì„±í•˜ê³ , í•´ë‹¹ SseEmitterë¥¼ ë°˜í™˜í•˜ê³  ìˆìŠµë‹ˆë‹¤.

SseEmitterëŠ” SSEë¥¼ êµ¬í˜„í•  ìˆ˜ ìˆë„ë¡ ìŠ¤í”„ë§ì´ ì œê³µí•˜ëŠ” í´ë˜ìŠ¤ë¡œ ì´ ê°ì²´ë¥¼ í†µí•´ ë°ì´í„°ë¥¼ ì „ì†¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
`SseEmitter = ì»¤ë„¥ì…˜`ì¸ ì…ˆì´ì£ .
SseEmitter ê°ì²´ë¡œ ì–´ë–¤ ì¼ì„ í•  ìˆ˜ ìˆëŠ”ì§€ëŠ” ë’¤ì—ì„œ ìì„¸í•˜ê²Œ ì„¤ëª…í•˜ê² ìŠµë‹ˆë‹¤.

EventStreamRegistryë¥¼ ì‚´í´ë´…ì‹œë‹¤.

``` java
@Component
public class EventStreamsRegistry {


   private final Map<String, EventStreams> registry;


   public EventStreamsRegistry() {
       this.registry = new ConcurrentHashMap<>();
   }


   public SseEmitter register(final String key) {
       final EventStreams eventStreams = registry.getOrDefault(key, new EventStreams());
       final EventStream eventStream = new SseEventStream();
       eventStreams.add(eventStream);
       registry.put(key, eventStreams);
       return eventStreams.publish(eventStream);
   }
```
register ë©”ì„œë“œì˜ ì—­í• ì„ ìš”ì•½í•˜ìë©´ Map ìë£Œêµ¬ì¡°ë¥¼ ê°€ì§„ `registry`ì— **í˜ì–´ë£¸ ì‹ë³„ì**ë¥¼ keyë¡œ, **EventStreams**ì„ valueë¡œ ì €ì¥í•˜ê³ , `eventStreams.publish` ë©”ì„œë“œë¡œ SseEmitterë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

EventStreamsëŠ” `List<EventStream>`ì„ í•„ë“œë¡œ ê°–ê³ ìˆëŠ” ì¼ê¸‰ ì»¬ë ‰ì…˜ì…ë‹ˆë‹¤.
EventStreamì€ `SseEmitter` ê°ì²´ë¥¼ ì´ìš©í•´ ì»¤ë„¥ì…˜ì„ ë§ºê±°ë‚˜, ë°ì´í„°ë¥¼ ì „ì†¡í•˜ëŠ” ì¸í„°í˜ì´ìŠ¤ì…ë‹ˆë‹¤.

ì½”ë“œê°€ ì¡°ê¸ˆ ë³µì¡í•´ì¡Œê¸° ë•Œë¬¸ì—, ì ê¹ ì…€í”„ Q&A ì‹œê°„ì„ ê°–ê² ìŠµë‹ˆë‹¤.
- Q) ì™œ í˜ì–´ë£¸ ì‹ë³„ì ë³„ë¡œ EventStreamsë¥¼ ë³´ê´€í•˜ë‚˜ìš”?
- A) í˜ì–´ë£¸ ë³„ë¡œ íƒ€ì´ë¨¸ë¥¼ ë…ë¦½ì ìœ¼ë¡œ ë™ê¸°í™” í•´ì•¼ í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. â€œí•˜ë‚˜ì˜ í˜ì–´ë£¸"ì— ëŒ€í•´ íƒ€ì´ë¨¸ ë™ê¸°í™”ë¥¼ í•´ì•¼ í•˜ëŠ”ë°, â€œëª¨ë“  í˜ì–´ë£¸"ì— ëŒ€í•´ íƒ€ì´ë¨¸ ë™ê¸°í™”ë¥¼ í•˜ë©´ í° ì¼ì´ ë°œìƒí•˜ê² ì£ ?
- Q) EventStreamì´ ì•„ë‹Œ EventStreamsë¡œ ë³´ê´€í•˜ëŠ” ì´ìœ ê°€ ë¬´ì—‡ì¸ê°€ìš”?
- A) ë‹¤ì¤‘ ì‚¬ìš©ìë¥¼ ê³ ë ¤í–ˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. í´ë¼ì´ì–¸íŠ¸ í•œ ëª…ë‹¹ í•˜ë‚˜ì˜ ì»¤ë„¥ì…˜ì´ ì¡´ì¬í•˜ê¸° ë•Œë¬¸ì— SseEmitterë„ í´ë¼ì´ì–¸íŠ¸ ìˆ˜ë§Œí¼ í•„ìš”í•©ë‹ˆë‹¤. ê·¸ë˜ì„œ í˜ì–´ë£¸ì— ì¡´ì¬í•˜ëŠ” ëª¨ë“  ì‚¬ìš©ìë“¤ì„ List<EventStream>ë¡œ ê´€ë¦¬í•©ë‹ˆë‹¤.


ì´ì œ EventStreamsì— ëŒ€í•´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.

``` java
public class EventStreams {


   private final List<EventStream> streams = new CopyOnWriteArrayList<>();


   public SseEmitter publish(final EventStream eventStream) {
       final SseEmitter sseEmitter = eventStream.connect();
       sseEmitter.onTimeout(sseEmitter::complete);
       sseEmitter.onCompletion(() -> streams.remove(eventStream));
       sseEmitter.onError(error -> streams.remove(eventStream));
       return sseEmitter;
   }

```
ì¸ìë¡œ ë°›ì€ EventStreamìœ¼ë¡œ ì»¤ë„¥ì…˜ì„ ìƒì„±í•©ë‹ˆë‹¤.
ì»¤ë„¥ì…˜ ìƒì„± í›„ ì»¤ë„¥ì…˜ì´ `íƒ€ì„ì•„ì›ƒ` ë  ê²½ìš°, ì»¤ë„¥ì…˜ì´ `ì¢…ë£Œ`ë  ê²½ìš°, ì»¤ë„¥ì…˜ì— `ì˜¤ë¥˜`ê°€ ë°œìƒí•  ê²½ìš° ì–´ë–¤ í–‰ë™ì„ í• ì§€ `ì½œë°± í•¨ìˆ˜`ë¥¼ ì§€ì •í•©ë‹ˆë‹¤.
ì½”ë“œì—ì„œëŠ” ìœ„ì˜ ì„¸ê°€ì§€ ìƒí™©ì´ ë°œìƒí–ˆì„ ë•Œ streamsì—ì„œ í•´ë‹¹ EventStreamì„ ì‚­ì œí•©ë‹ˆë‹¤.

EventStreamì˜ êµ¬í˜„ì²´ì¸ SseEventStreamì— ëŒ€í•´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.
``` java
public class SseEventStream implements EventStream {


   private static final Duration TIME_OUT = Duration.ofMinutes(20);
   private static final String CONNECT_NAME = "connect";
   private static final String SUCCESS_MESSAGE = "OK";


   private final AtomicLong id = new AtomicLong(0);
   private final SseEmitter sseEmitter;


   public SseEventStream() {
       this.sseEmitter = new SseEmitter(TIME_OUT.toMillis());
   }


   @Override
   public SseEmitter connect() {
       final String eventId = String.valueOf(id.incrementAndGet());
       try {
           sseEmitter.send(SseEmitter.event()
                   .id(eventId)
                   .name(CONNECT_NAME)
                   .data(SUCCESS_MESSAGE));
       } catch (final IOException e) {
           sseEmitter.complete();
           throw new SseConnectionFailureException("SSE ì—°ê²°ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
       }
       return sseEmitter;
   }
```
SseEmitterì˜ ê¸°ë³¸ íƒ€ì„ì•„ì›ƒ ì‹œê°„ì€ 30ì´ˆì…ë‹ˆë‹¤. 30ì´ˆ ë’¤ì— ë¬´ì¡°ê±´ ì»¤ë„¥ì…˜ì´ ëŠì–´ì§„ë‹¤ëŠ” ì˜ë¯¸ì…ë‹ˆë‹¤.  
ë³´í†µ íƒ€ì„ì•„ì›ƒì€ ì•„ë¬´ëŸ° ë°ì´í„°ê°€ ì „ì†¡ë˜ì§€ ì•ŠëŠ” *ìœ íœ´ ìƒíƒœê°€ ì§€ì†ë  ê²½ìš°*ë¥¼ ëœ»í•˜ì§€ë§Œ, SseEmitterì˜ ê²½ìš° ì§€ì†ì ìœ¼ë¡œ ë°ì´í„°ê°€ ì „ì†¡ë˜ê³  ìˆë”ë¼ë„ ì²« ë°ì´í„° ì „ì†¡ ì‹œê°„ìœ¼ë¡œë¶€í„° 30ì´ˆê°€ ì§€ë‚˜ë©´ ë¬´ì¡°ê±´ íƒ€ì„ì•„ì›ƒì´ ë°œìƒí•©ë‹ˆë‹¤.
íƒ€ì„ì•„ì›ƒì´ ë°œìƒí•˜ë©´ ë”ì´ìƒ ì»¤ë„¥ì…˜ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ê¸° ë•Œë¬¸ì— ìƒˆë¡œìš´ ì»¤ë„¥ì…˜ì„ ìƒì„±í•´ ì£¼ì–´ì•¼ í•©ë‹ˆë‹¤.  

SseEmitterë¥¼ ìƒì„±í•  ë•Œ íƒ€ì„ì•„ì›ƒ ì‹œê°„ì„ ì§€ì •í•´ ì¤„ ìˆ˜ ìˆëŠ”ë°, ì €ëŠ” 20ë¶„ìœ¼ë¡œ ì„¤ì •í•´ ì£¼ì—ˆìŠµë‹ˆë‹¤.  

connect ë©”ì„œë“œë¥¼ ì‚´í´ë³´ë©´, SseEmitter ê°ì²´ë¥¼ í†µí•´ ë°ì´í„°ë¥¼ ì „ì†¡í•˜ê³  ìˆìŠµë‹ˆë‹¤.  
ì»¤ë„¥ì…˜ ì—°ê²°ì— ì„±ê³µí–ˆì„ ì‹œ nameì€ â€œconnectâ€, dataëŠ” â€œOKâ€ê°€ ì „ì†¡ë©ë‹ˆë‹¤.  

ê°œë°œì ë„êµ¬ë¥¼ ì—´ì–´ ë„¤íŠ¸ì›Œí¬ ì°½ì˜ EventStreamì„ í™•ì¸í•˜ë©´ ì•„ë˜ì™€ ê°™ì€ í™”ë©´ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.  
![img_2.png](img_2.png)

SSE ì»¤ë„¥ì…˜ì„ ë§ºëŠ” ê²ƒì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤.  
ì´ì œ íƒ€ì´ë¨¸ë¥¼ ì‹œì‘í•´ ë´…ì‹œë‹¤.  
### 2 - íƒ€ì´ë¨¸ ì‹œì‘
``` java
@RestController
public class TimerController implements TimerDocs {


private final SchedulerService schedulerService;


@PatchMapping("/{accessCode}/timer/start")
public ResponseEntity<Void> createTimerStart(@PathVariable("accessCode") final String accessCode) {
schedulerService.start(accessCode);
return ResponseEntity.noContent()
.build();
}
```

ì»¨íŠ¸ë¡¤ëŸ¬ì— íƒ€ì´ë¨¸ ì‹œì‘ ìš”ì²­ apië¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
accessCodeëŠ” í˜ì–´ë£¸ ì‹ë³„ìë¥¼ ëœ»í•©ë‹ˆë‹¤. SSE ì»¤ë„¥ì…˜ì„ ë§ºì„ ë•Œ ì‚¬ìš©ë˜ì—ˆë˜ keyì™€ ê°™ìŠµë‹ˆë‹¤.

SchedulerServiceë¥¼ ì‚´í´ë´…ì‹œë‹¤.
``` java
public void start(final String key) {
   if (schedulerRegistry.isActive(key)) {
       return;
   }
   sseService.broadcast(key, "timer", "start");
   if (isInitial(key)) {
       final Timer timer = timerRepository.fetchTimerByAccessCode(key)
               .toDomain();
       scheduling(key, timer);
       timestampRegistry.register(key, timer);
       return;
   }
   final Timer timer = timestampRegistry.get(key);
   scheduling(key, timer);
}


private boolean isInitial(final String key) {
   return !schedulerRegistry.has(key) && !timestampRegistry.has(key);
}


private void scheduling(final String key, final Timer timer) {
   final Trigger trigger = new PeriodicTrigger(DELAY_SECOND);
   final ScheduledFuture<?> schedule = taskScheduler.schedule(() -> runTimer(key, timer), trigger);
   schedulerRegistry.register(key, schedule);
}


private void runTimer(final String key, final Timer timer) {
   if (timer.isTimeUp() && schedulerRegistry.has(key)) {
       stop(key, timer);
       return;
   }
   if (sseService.hasNoConnections(key) && schedulerRegistry.has(key)) {
       pause(key);
       return;
   }
   timer.decreaseRemainingTime(DELAY_SECOND.toMillis());
   sseService.broadcast(key, "remaining-time", String.valueOf(timer.getRemainingTime()));
}
```

ì½”ë“œê°€ ë³µì¡í•˜ë‹ˆ ë©”ì„œë“œ í•˜ë‚˜ì”© ì²œì²œíˆ ì‚´í´ë´…ì‹œë‹¤.

``` java
public void start(final String key) {
   if (schedulerRegistry.isActive(key)) {
       return;
   }
   sseService.broadcast(key, "timer", "start");
   if (isInitial(key)) {
       final Timer timer = timerRepository.fetchTimerByAccessCode(key)
               .toDomain();
       scheduling(key, timer);
       timestampRegistry.register(key, timer);
       return;
   }
   final Timer timer = timestampRegistry.get(key);
   scheduling(key, timer);
}
```
start ë©”ì„œë“œì—ì„œëŠ” ë¨¼ì € íƒ€ì´ë¨¸ê°€ **ì‹¤í–‰ë˜ì—ˆë‹¤ê°€ ì¤‘ë‹¨**ëœ ìƒíƒœì¸ì§€, ì•„ë‹ˆë©´ **í•œë²ˆë„ ì‹¤í–‰ë˜ì§€ ì•Šì€** ìƒíƒœì¸ì§€ë¥¼ êµ¬ë¶„í•©ë‹ˆë‹¤.  
ë‘ ìƒíƒœë¥¼ êµ¬ë¶„í•˜ëŠ” ì´ìœ ëŠ” íƒ€ì´ë¨¸ ì´ ì‹œê°„ì€ `DB`ì—ì„œ ê´€ë¦¬í•˜ì§€ë§Œ, íƒ€ì´ë¨¸ì˜ í˜„ì¬ ì‹œê°„, ì¦‰ íƒ€ì´ë¨¸ ë‚¨ì€ ì‹œê°„ì€ `ì¸ë©”ëª¨ë¦¬`ë¡œ ê´€ë¦¬í•˜ê³  ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. íƒ€ì´ë¨¸ ì‹œê°„ì´ 1ì´ˆì”© ì¤„ì–´ë“¤ ë•Œë§ˆë‹¤ dbì— ì—…ë°ì´íŠ¸ í•  ìˆ˜ ì—†ê¸° ë•Œë¬¸ì— íƒ€ì´ë¨¸ ë‚¨ì€ ì‹œê°„ì€ TimeStampRegistryì—ì„œ ê´€ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤.  

íƒ€ì´ë¨¸ê°€ í•œë²ˆë„ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ë‹¤ë©´ TimeStampRegistryì— íƒ€ì´ë¨¸ ì‹œê°„ì´ ì €ì¥ë˜ì–´ ìˆì§€ ì•Šì€ íƒ€ì´ë¨¸ ì´ˆê¸°í™” ìƒíƒœì´ê¸° ë•Œë¬¸ì— DBì—ì„œ íƒ€ì´ë¨¸ ì´ ì‹œê°„ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.  
íƒ€ì´ë¨¸ê°€ ì‹¤í–‰ë˜ì—ˆë˜ ì ì´ ìˆë‹¤ë©´(ì‹¤í–‰ í›„ ì¼ì‹œì •ì§€ ìƒíƒœ), TimeStampRegistryì—ì„œ íƒ€ì´ë¨¸ í˜„ì¬ ì‹œê°„ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.  
DB, í˜¹ì€ TimeStampRegistryì—ì„œ ê°€ì ¸ì˜¨ ì‹œê°„ì„ ì´ìš©í•´ ìŠ¤ì¼€ì¤„ë§ì„ ì‹œì‘í•©ë‹ˆë‹¤.  

- Q) ê°‘ìê¸° ìŠ¤ì¼€ì¤„ë§ì€ ì™œ ë“±ì¥í•˜ë‚˜ìš”?
- A) ì‚¬ìš©ìê°€ íƒ€ì´ë¨¸ ì¼ì‹œì •ì§€ ë²„íŠ¼ì„ ëˆ„ë¥´ê¸° ì „ê¹Œì§€ *ìë™ìœ¼ë¡œ* íƒ€ì´ë¨¸ í˜„ì¬ ì‹œê°„ì„ 1ì´ˆë§ˆë‹¤ ì „ì†¡í•´ì•¼ í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

```java
private void scheduling(final String key, final Timer timer) {
    final Trigger trigger = new PeriodicTrigger(DELAY_SECOND);
    final ScheduledFuture<?> schedule = taskScheduler.schedule(() -> runTimer(key, timer), trigger);
    schedulerRegistry.register(key, schedule);
}
```
ìŠ¤ì¼€ì¤„ëŸ¬ ì‹¤í–‰ ì£¼ê¸°ëŠ” 1ì´ˆë§ˆë‹¤ ì‹œê°„ì„ ì „ì†¡í•´ì•¼ í•˜ë¯€ë¡œ `1ì´ˆ`ë¡œ ì„¤ì •í–ˆìŠµë‹ˆë‹¤.  
ThreadPoolTaskSchedulerë¥¼ í™œìš©í•´ 1ì´ˆì— í•œë²ˆì”© runTimer ë©”ì„œë“œê°€ ì‹¤í–‰ë˜ë„ë¡ í•´ ì£¼ì—ˆìŠµë‹ˆë‹¤.  
ìŠ¤ì¼€ì¤„ëŸ¬ ì‹¤í–‰ ê²°ê³¼ëŠ” í˜ì–´ë£¸ ì‹ë³„ì ë³„ë¡œ SchedulerRegistryì— ì €ì¥ë©ë‹ˆë‹¤.  

``` java
private void runTimer(final String key, final Timer timer) {
   if (timer.isTimeUp() && schedulerRegistry.has(key)) {
       stop(key, timer);
       return;
   }
   if (sseService.hasNoConnections(key) && schedulerRegistry.has(key)) {
       pause(key);
       return;
   }
   timer.decreaseRemainingTime(DELAY_SECOND.toMillis());
   sseService.broadcast(key, "remaining-time", String.valueOf(timer.getRemainingTime()));
}
```
runTimerì—ì„œëŠ” íƒ€ì´ë¨¸ í˜„ì¬ ì‹œê°„ì„ 1ì´ˆ ì¤„ì´ê³ , í˜ì–´ë£¸ì— ìˆëŠ” ëª¨ë“  í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ë‚¨ì€ ì‹œê°„ì„ ì „ì†¡í•©ë‹ˆë‹¤.

ì „ì†¡ ê³¼ì •ì„ êµ¬ì²´ì ìœ¼ë¡œ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.
1. í˜ì–´ë£¸ ì‹ë³„ìë¡œ EventStreams ì°¾ê³ , í•´ë‹¹ EventStreamsì— broadcast ì ìš©
``` java
public void broadcast(final String key, final String event, final String data) {
   final EventStreams emitters = eventStreamsRegistry.findEventStreams(key);
   emitters.broadcast(event, data);
}
```
2. List<EventStream>ì˜ ëª¨ë“  ìš”ì†Œë¥¼ ëŒ€ìƒìœ¼ë¡œ flush ìˆ˜í–‰
```java
public void broadcast(final String name, final String message) {
   streams.forEach(eventStream -> eventStream.flush(name, message));
}
```
3. EventStream(SseEventStream)ì˜ í•„ë“œì¸ SseEmitterë¡œ ë°ì´í„° ì „ì†¡
``` java
@Override
public void flush(final String name, final String message) {


   final String eventId = String.valueOf(id.incrementAndGet());
   try {
       sseEmitter.send(SseEmitter.event()
               .id(eventId)
               .name(name)
               .data(message)
       );
   } catch (final IOException ignored) {
   }
}
```
ë‹¤ì‹œ runTimerë¡œ ëŒì•„ê°€ê² ìŠµë‹ˆë‹¤.
``` java
   private void runTimer(final String key, final Timer timer) {
       if (timer.isTimeUp()) {
           stop(key);
           final Timer initalTimer = new Timer(timer.getAccessCode(), timer.getDuration(), timer.getDuration());
           timestampRegistry.register(key, initalTimer);
           return;
       }
       if (sseService.hasNoConnections(key)) {
           stop(key);
           return;
       }
       timer.decreaseRemainingTime(DELAY_SECOND.toMillis());
       sseService.broadcast(key, "remaining-time", String.valueOf(timer.getRemainingTime()));
   }
```
íƒ€ì´ë¨¸ í˜„ì¬ ì‹œê°„ì´ 0ì´ˆê°€ ëœë‹¤ë©´(íƒ€ì´ë¨¸ê°€ í•œë°”í€´ ëŒì•˜ì„ ë•Œ), íƒ€ì´ë¨¸ë¥¼ ì •ì§€í•˜ê³  íƒ€ì´ë¨¸ í˜„ì¬ ì‹œê°„ì„ íƒ€ì´ë¨¸ ì´ ì‹œê°„ìœ¼ë¡œ ì´ˆê¸°í™” í•©ë‹ˆë‹¤.  
í˜ì–´ë£¸ì— ì‚¬ìš©ìê°€ ì•„ë¬´ë„ ì—†ì„ ê²½ìš°ì—ë„ íƒ€ì´ë¨¸ë¥¼ ì •ì§€í•©ë‹ˆë‹¤.  
íƒ€ì´ë¨¸ë¥¼ ì¤‘ì§€í•˜ëŠ” stop ë©”ì„œë“œëŠ” íƒ€ì´ë¨¸ ì¼ì‹œì •ì§€ ëª©ì°¨ì—ì„œ ì„¤ëª…ë“œë¦¬ê² ìŠµë‹ˆë‹¤.  

ì´ì œ íƒ€ì´ë¨¸ë¥¼ ì‹œì‘í•˜ë©´,
![img_1.png](img_1.png)
ìœ„ ì‚¬ì§„ê³¼ ê°™ì€ ê²°ê³¼ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.  
ì‚¬ì§„ì— ìˆëŠ” íƒ€ì´ë¨¸ ì‹œê°„ì€ ë°€ë¦¬ì´ˆ ê¸°ì¤€ìœ¼ë¡œ, íƒ€ì´ë¨¸ ì‹œê°„ì´ 1000ë°€ë¦¬ì´ˆ(1ì´ˆ)ì”© ì¤„ì–´ë“¤ê³  ìˆìŠµë‹ˆë‹¤.  

### 3 - íƒ€ì´ë¨¸ ì¼ì‹œì •ì§€
ì´ì œ ì‹¤í–‰ì¤‘ì¸ íƒ€ì´ë¨¸ë¥¼ ì¼ì‹œì •ì§€ í•´ ë´…ì‹œë‹¤.
ì´ì „ ë‹¨ê³„ì™€ ë§ˆì°¬ê°€ì§€ë¡œ íƒ€ì´ë¨¸ ì¼ì‹œì •ì§€ apië¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.

```java
@PatchMapping("/{accessCode}/timer/stop")
public ResponseEntity<Void> createTimerStop(@PathVariable("accessCode") final String accessCode) {
    schedulerService.pause(accessCode);
    
    return ResponseEntity.noContent()
            .build();
}
```
schedulerService.pause ë©”ì„œë“œë¥¼ ì‚´í´ë´…ì‹œë‹¤.
``` java
public void pause(final String key) {
    sseService.broadcast(key, "timer", "pause");
    schedulerRegistry.release(key);
}
```
í˜ì–´ë£¸ì— ìˆëŠ” ëª¨ë“  ì‚¬ìš©ìì—ê²Œ íƒ€ì´ë¨¸ê°€ ì •ì§€ë˜ì—ˆë‹¤ëŠ” ë°ì´í„°ë¥¼ ì „ì†¡í•©ë‹ˆë‹¤.  
ê·¸ í›„, SchedulerRegistryì—ì„œ íƒ€ì´ë¨¸ë¥¼ ì •ì§€í•˜ê³ ì í•˜ëŠ” í˜ì–´ë£¸ì˜ ìŠ¤ì¼€ì¤„ëŸ¬ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.
```java
@Component
public class SchedulerRegistry {
    
    private final Map<String, ScheduledFuture<?>> registry;
    
    public SchedulerRegistry() {
        this.registry = new ConcurrentHashMap<>();
    }
    
    public void register(final String key, final ScheduledFuture<?> future) {
        registry.put(key, future);
    }
    
    public void release(final String key) {
        if (!registry.containsKey(key)) {
            throw new NotFoundScheduledFutureException("í‚¤ì— í•´ë‹¹í•˜ëŠ” ìŠ¤ì¼€ì¤„ëŸ¬ ê²°ê³¼ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        }
        registry.get(key)
                .cancel(false);
        registry.remove(key);
    }
```
SchedulerRegistryëŠ” í˜ì–´ë£¸ ë³„ ìŠ¤ì¼€ì¤„ë§ ê²°ê³¼ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.  
release ë©”ì„œë“œë¥¼ ì‚´í´ë³´ë©´, registryì—ì„œ í˜ì–´ë£¸ ì‹ë³„ìë¡œ í˜ì–´ë£¸ ê²°ê³¼ë¥¼ ê°€ì ¸ì˜¤ê³  ìˆìŠµë‹ˆë‹¤.  
ScheduledFutureëŠ” ìŠ¤ì¼€ì¤„ëŸ¬ì˜ í˜„ì¬ ìƒíƒœë¥¼ ì•Œ ìˆ˜ ìˆëŠ” ìŠ¤í”„ë§ì´ ì œê³µí•˜ëŠ” í´ë˜ìŠ¤ì…ë‹ˆë‹¤.  
ScheduledFutureì˜ ìƒíƒœë¥¼ cancelë¡œ ë³€ê²½í•˜ì—¬ ì‹¤í–‰ì¤‘ì´ë˜ ìŠ¤ì¼€ì¤„ëŸ¬ë¥¼ ì¢…ë£Œí•˜ê³ , í•´ë‹¹ ScheduledFutureë¥¼ registryì—ì„œ ì‚­ì œí•©ë‹ˆë‹¤.  

![img_3.png](img_3.png)
ì„±ê³µì ìœ¼ë¡œ íƒ€ì´ë¨¸ê°€ ì¤‘ë‹¨ë˜ë©´, 1ì´ˆë§ˆë‹¤ ì „ì†¡ë˜ë˜ íƒ€ì´ë¨¸ í˜„ì¬ ì‹œê°„ì´ ë”ì´ìƒ ì „ì†¡ë˜ì§€ ì•Šê³  timer pause ë©”ì„¸ì§€ê°€ ë§ˆì§€ë§‰ìœ¼ë¡œ ì „ì†¡ë©ë‹ˆë‹¤.

## íŠ¸ëŸ¬ë¸” ìŠˆíŒ…
ì§€ê¸ˆê¹Œì§€ SSEë¥¼ ì‚¬ìš©í•˜ì—¬ íƒ€ì´ë¨¸ë¥¼ ë™ê¸°í™”í•˜ëŠ” ë°©ë²•ì— ëŒ€í•´ ì•Œì•„ë³´ì•˜ìŠµë‹ˆë‹¤.  
SSEë¥¼ ë„ì…í•˜ë©´ì„œ ë‹¤ì–‘í•œ ì—ëŸ¬ ìƒí™©ì„ ë§ˆì£¼í–ˆëŠ”ë°ìš”, ì´ ê¸€ì„ ë³´ì‹œëŠ” ì—¬ëŸ¬ë¶„ë„ ê°™ì€ ë¬¸ì œë¥¼ ê²ªì§€ ì•Šë„ë¡ íŠ¸ëŸ¬ë¸” ìŠˆíŒ… ê³¼ì •ì„ ê³µìœ í•˜ê² ìŠµë‹ˆë‹¤.

### ë¬¸ì œ 1) íƒ€ì´ë¨¸ ì‹¤í–‰/ì¼ì‹œì¤‘ì§€ ë²„íŠ¼ì´ ë™ê¸°í™” ë˜ì§€ ì•Šì•„ìš”
ë”°ë¡œ ì–¸ê¸‰í•˜ì§€ëŠ” ì•Šì•˜ì§€ë§Œ, ì‚¬ì‹¤ ìœ„ì˜ ì½”ë“œ ì•ˆì— íƒ€ì´ë¨¸ ë²„íŠ¼ ë™ê¸°í™” ë¡œì§ì´ ìˆ¨ì–´ìˆì—ˆìŠµë‹ˆë‹¤.
íƒ€ì´ë¨¸ë¥¼ ì‹¤í–‰í•˜ê±°ë‚˜ ì¤‘ì§€í•  ë•Œ ì–´ë–¤ ì´ë²¤íŠ¸ê°€ ë°œìƒí–ˆëŠ”ì§€ ì•Œë ¤ì£¼ëŠ” â€œì´ë²¤íŠ¸ ë©”ì„¸ì§€"ë¥¼ í•¨ê»˜ ì „ì†¡í•˜ë©´ íƒ€ì´ë¨¸ ë²„íŠ¼ë„ ë™ê¸°í™” í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

íƒ€ì´ë¨¸ ì¤‘ì§€ ë©”ì„œë“œë¥¼ ë³´ë©´, íƒ€ì´ë¨¸ë¥¼ ì¤‘ì§€í•  ë•Œ â€œtimer pauseâ€ ë©”ì„¸ì§€ë¥¼ í•¨ê»˜ ì „ì†¡í•˜ê³  ìˆìŠµë‹ˆë‹¤.
``` java
public void pause(final String key) {
   sseService.broadcast(key, "timer", "pause");
   schedulerRegistry.release(key);
}
```
íƒ€ì´ë¨¸ ì‹¤í–‰ ë©”ì„œë“œì—ì„œë„ â€œtimer startâ€ ë©”ì„¸ì§€ë¥¼ ì „ì†¡í•œ ë’¤ 1ì´ˆë§ˆë‹¤ íƒ€ì´ë¨¸ ì‹œê°„ì„ ë³´ë‚´ì£¼ê³  ìˆë„¤ìš”.
``` java
public void start(final String key) {
   if (schedulerRegistry.isActive(key)) {
       return;
   }
   sseService.broadcast(key, "timer", "start");
   if (isInitial(key)) {
       final Timer timer = timerRepository.fetchTimerByAccessCode(key)
               .toDomain();
       scheduling(key, timer);
       timestampRegistry.register(key, timer);
       return;
   }
   final Timer timer = timestampRegistry.get(key);
   scheduling(key, timer);
}
```
ì´ì œ í”„ë¡ íŠ¸ì—”ë“œ ë‹¨ì—ì„œ íƒ€ì´ë¨¸ ì‹¤í–‰ ë²„íŠ¼ì„ í™œì„±í™” í• ì§€, íƒ€ì´ë¨¸ ì¤‘ì§€ ë²„íŠ¼ì„ í™œì„±í™” í• ì§€ ê²°ì •í•˜ëŠ” ê·¼ê±°ëŠ” â€œstartâ€ ë©”ì„¸ì§€ê°€ ì˜¤ëŠëƒ, â€œstopâ€ ë©”ì„¸ì§€ê°€ ì˜¤ëŠëƒì— ë”°ë¼ ë‹¬ë¼ì§‘ë‹ˆë‹¤.

íƒ€ì´ë¨¸ í˜„ì¬ ì‹œê°„ì„ ë³´ë‚´ì£¼ê±°ë‚˜ íƒ€ì´ë¨¸ë¥¼ ì¤‘ì§€í•˜ëŠ” ì¼ë§Œ í•˜ë©´ ë˜ì§€, êµ³ì´ â€œtimer startâ€ì™€ â€œtimer stopâ€ ë©”ì„¸ì§€ë¥¼ ì¶”ê°€ë¡œ ì „ì†¡í–ˆë˜ ì´ìœ ê°€ ë°”ë¡œ *ë²„íŠ¼ ë™ê¸°í™”* ë•Œë¬¸ì´ì—ˆìŠµë‹ˆë‹¤.

ë§Œì•½ ì´ë²¤íŠ¸ ë©”ì„¸ì§€ê°€ ì—†ë‹¤ë©´, íƒ€ì´ë¨¸ë¥¼ ì‹¤í–‰í–ˆì„ ë•Œ íƒ€ì´ë¨¸ ì‹¤í–‰ ë²„íŠ¼ì„ ëˆ„ë¥¸ ì‚¬ìš©ìì˜ í™”ë©´ë§Œ ì •ì§€ ë²„íŠ¼ì´ í™œì„±í™” ë˜ê³ , í˜ì–´ë£¸ì— ìˆë˜ ë‹¤ë¥¸ ì‚¬ìš©ìëŠ” ì‹œì‘ ë²„íŠ¼ì´ í™œì„±í™” ëœ ì±„ë¡œ íƒ€ì´ë¨¸ê°€ ì§„í–‰ë  ê²ƒì…ë‹ˆë‹¤.
### ë¬¸ì œ 2) ì„¤ì •í•œ íƒ€ì„ì•„ì›ƒ ì‹œê°„ë³´ë‹¤ ì¼ì° ì»¤ë„¥ì…˜ì´ ì¢…ë£Œë¼ìš” in í…ŒìŠ¤íŠ¸ ì„œë²„
SseEmitterì˜ íƒ€ì„ì•„ì›ƒ ì‹œê°„ì„ 20ë¶„ìœ¼ë¡œ ì„¤ì •í–ˆê¸° ë•Œë¬¸ì— ì»¤ë„¥ì…˜ì´ ë§ºì–´ì§„ ë’¤ 20ë¶„ì´ ì§€ë‚˜ë©´ ì»¤ë„¥ì…˜ì´ ìë™ìœ¼ë¡œ ì¢…ë£Œë©ë‹ˆë‹¤.
ê·¸ëŸ¬ë‚˜ 20ë¶„ì´ ë˜ê¸°ë„ ì „, `net::ERR_HTTP2_PROTOCOL_ERROR 200` ì—ëŸ¬ì™€ í•¨ê»˜ ì»¤ë„¥ì…˜ì´ 1ë¶„ë§Œì— ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.

ì´ ë¬¸ì œëŠ” ë¡œì»¬ì—ì„œëŠ” ë°œìƒí•˜ì§€ ì•Šì•˜ê³ , í…ŒìŠ¤íŠ¸ ì„œë²„ì—ì„œ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.

NginxëŠ” í”„ë¡ì‹œ ì„œë²„ê°€ ë¬´ê¸°í•œ ëŒ€ê¸°í•˜ëŠ” ê²ƒì„ ë°©ì§€í•˜ê¸° ìœ„í•´ `proxy_read_time` ì˜µì…˜ìœ¼ë¡œ ì‘ë‹µì„ ê¸°ë‹¤ë¦¬ëŠ” ìµœëŒ€ ì‹œê°„ì„ ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
`proxy_read_time` ê¸°ë³¸ê°’ì´ 60ì´ˆì´ê¸° ë•Œë¬¸ì— SSE ì»¤ë„¥ì…˜ë„ 1ë¶„ ë’¤ ì¢…ë£Œëœ ê²ƒì…ë‹ˆë‹¤.

Nginx config íŒŒì¼ì— ì•„ë˜ì™€ ê°™ì´ íƒ€ì„ì•„ì›ƒ ì‹œê°„ì„ 20ë¶„ìœ¼ë¡œ ì„¤ì •í•´ ì£¼ì—ˆë”ë‹ˆ ì •ìƒ ë™ì‘í•˜ì˜€ìŠµë‹ˆë‹¤.
```
location /api/ {
    proxy_read_timeout 20m;  
}
```
### ë¬¸ì œ 3) ì„¤ì •í•œ íƒ€ì„ì•„ì›ƒ ì‹œê°„ë³´ë‹¤ ì¼ì° ì»¤ë„¥ì…˜ì´ ì¢…ë£Œë¼ìš” in ìš´ì˜ ì„œë²„
í…ŒìŠ¤íŠ¸ ì„œë²„ì—ì„œ íƒ€ì„ì•„ì›ƒ ë¬¸ì œë¥¼ í•´ê²°í–ˆë”ë‹ˆ, ì´ì œëŠ” ìš´ì˜ ì„œë²„ì—ì„œ ê°™ì€ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
ìš´ì˜ ì„œë²„ëŠ” í…ŒìŠ¤íŠ¸ ì„œë²„ì™€ ë‹¬ë¦¬ `ë¡œë“œë°¸ëŸ°ì„œ`ë¥¼ ì ìš©í•œ ìƒíƒœì˜€ìŠµë‹ˆë‹¤.

`AWS ë¡œë“œ ë°¸ëŸ°ì„œ - Load Balancer ì†ì„± í¸ì§‘`ì— ë“¤ì–´ê°€ë©´ `ì—°ê²° ìœ íœ´ ì œí•œ ì‹œê°„`ì„ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
![img_8.png](img_8.png)
ìœ íœ´ ì œí•œ ì‹œê°„ì´ë€ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì‚¬ìš©ìê°€ ì¼ì • ì‹œê°„ë™ì•ˆ ì•„ë¬´ëŸ° í™œë™ì„ í•˜ì§€ ì•Šì„ ê²½ìš° ì—°ê²°ì„ ìë™ìœ¼ë¡œ ì¢…ë£Œí•˜ëŠ” ë©”ì»¤ë‹ˆì¦˜ì„ ë§í•©ë‹ˆë‹¤.
ìœ íœ´ ì œí•œ ì‹œê°„ ê¸°ë³¸ê°’ì´ 1ë¶„ì´ê¸° ë•Œë¬¸ì— ì»¤ë„¥ì…˜ë„ 1ë¶„ ë’¤ ì¢…ë£Œëœ ê²ƒì…ë‹ˆë‹¤.

ì²˜ìŒì—ëŠ” ìœ íœ´ ì‹œê°„ì„ íƒ€ì„ì•„ì›ƒ ì‹œê°„ê³¼ ê°™ê²Œ 20ë¶„ìœ¼ë¡œ ì„¤ì •í–ˆìœ¼ë‚˜, ë¬¸ì œê°€ í•´ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.
ê·¸ë˜ì„œ ìœ íœ´ ì‹œê°„ì„ 25ë¶„ìœ¼ë¡œ ëŠ˜ë ¤ ì£¼ì—ˆë”ë‹ˆ íƒ€ì„ì•„ì›ƒ ì‹œê°„ë³´ë‹¤ ì¼ì° ì»¤ë„¥ì…˜ì´ ì¢…ë£Œë˜ëŠ” ë¬¸ì œë¥¼ í•´ê²°í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.
![img_7.png](img_7.png)
### ë¬¸ì œ 4) ìš´ì˜ ì„œë²„ì—ì„œ íƒ€ì´ë¨¸ ë™ê¸°í™”ê°€ ë˜ì§€ ì•Šì•„ìš”
ì´ê²Œ ë¬´ìŠ¨ ìƒí™©ì¼ê¹Œìš”â€¦ğŸ˜±  
ì½”ë”©í•´ë“€ì˜¤ ìš´ì˜ ì„œë²„ëŠ” AWS ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë‘ëŒ€ ë„ìš´ ìƒíƒœì´ê³ , ë¡œë“œë°¸ëŸ°ì„œê°€ ì„ì˜ë¡œ ë‘ ì¸ìŠ¤í„´ìŠ¤ ì¤‘ í•˜ë‚˜ì˜ ì¸ìŠ¤í„´ìŠ¤ì— íŠ¸ë˜í”½ì„ ì „ì†¡í•©ë‹ˆë‹¤.  
ë‘ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ê°ê° `ì¸ìŠ¤í„´ìŠ¤ A`, `ì¸ìŠ¤í„´ìŠ¤ B`ë¼ê³  ì§€ì¹­í•˜ê² ìŠµë‹ˆë‹¤.

íƒ€ì´ë¨¸ ë™ê¸°í™”ê°€ ë˜ì§€ ì•Šì€ ì´ìœ ëŠ” íƒ€ì´ë¨¸ í˜„ì¬ ì‹œê°„ì„ *ì¸ë©”ëª¨ë¦¬*ë¡œ ê´€ë¦¬í•˜ê³  ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.  
ë™ê¸°í™”ì— ì‹¤íŒ¨í•˜ëŠ” ì‹œë‚˜ë¦¬ì˜¤ëŠ” ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.  
1. í˜ì–´ë£¸ì— ì²«ë²ˆì§¸ ì‚¬ìš©ìê°€ ì…ì¥í•œë‹¤. í•´ë‹¹ ì‚¬ìš©ìëŠ” `ì¸ìŠ¤í„´ìŠ¤ A`ë¥¼ ê±°ì³ í˜ì–´ë£¸ì— ì…ì¥íŒë‹¤. 
2. ì²«ë²ˆì§¸ ì‚¬ìš©ìê°€ ì´ 10ë¶„ìœ¼ë¡œ ì„¤ì •ëœ íƒ€ì´ë¨¸ë¥¼ ì‹¤í–‰í•œë‹¤.
3. íƒ€ì´ë¨¸ê°€ 3ë¶„ë™ì•ˆ ë™ì‘í•˜ì—¬ íƒ€ì´ë¨¸ í˜„ì¬ ì‹œê°„ì´ 7ë¶„ì¸ í˜ì–´ë£¸ì— ë‘ë²ˆì§¸ ì‚¬ìš©ìê°€ ì…ì¥í•œë‹¤. í•´ë‹¹ ì‚¬ìš©ìëŠ” `ì¸ìŠ¤í„´ìŠ¤ B`ë¥¼ ê±°ì³ í˜ì–´ë£¸ì— ì…ì¥í•œë‹¤.
4. ì²«ë²ˆì§¸ ì‚¬ìš©ìì˜ íƒ€ì´ë¨¸ í˜„ì¬ ì‹œê°„ì¸ 7ë¶„ì€ *`ì¸ìŠ¤í„´ìŠ¤ B`ì˜ í†°ìº£ ì¸ë©”ëª¨ë¦¬ì— ì €ì¥ë˜ì–´ ìˆì§€ ì•Šë‹¤.* ê·¸ë˜ì„œ ë‘ë²ˆì§¸ ì‚¬ìš©ìì˜ íƒ€ì´ë¨¸ëŠ” 7ë¶„ë¶€í„° ì‹œì‘í•˜ëŠ” ê²ƒì´ ì•„ë‹Œ, ì´ˆê¸°í™” ëœ ìƒíƒœì¸ 10ë¶„ë¶€í„° ë™ì‘í•˜ê¸° ì‹œì‘í•œë‹¤.

í†°ìº£ ì„œë²„ê°€ ì¸ìŠ¤í„´ìŠ¤ ë³„ë¡œ ë…ë¦½ì ìœ¼ë¡œ ê´€ë¦¬ë˜ê³  ìˆê¸° ë•Œë¬¸ì— ì¸ë©”ëª¨ë¦¬ ë°ì´í„° ì—­ì‹œ ë‹¤ë¥¸ ì¸ìŠ¤í„´ìŠ¤ì™€ ê³µìœ ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

ì´ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ í˜ì–´ë£¸ ì‹ë³„ì prefixë¡œ `IAN`, `IBN`ì„ ì¶”ê°€í•˜ê³ , ë¡œë“œë°¸ëŸ°ì„œ ë¦¬ìŠ¤ë„ˆ ê·œì¹™ ì¡°ê±´ìœ¼ë¡œ ê²½ë¡œ íŒ¨í„´ì„ ì„¤ì •í•´ ì£¼ì—ˆìŠµë‹ˆë‹¤.
![img_6.png](img_6.png)
ì´ì œë¶€í„° ì‹ë³„ìê°€ `IAN`ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” í˜ì–´ë£¸ì€ ë¬´ì¡°ê±´ `ì¸ìŠ¤í„´ìŠ¤ A`ë¡œ ì „ë‹¬ë˜ê³ ,
ì‹ë³„ìê°€ `IBN`ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” í˜ì–´ë£¸ì€ ë¬´ì¡°ê±´ `ì¸ìŠ¤í„´ìŠ¤ B`ë¡œ ì „ë‹¬ë©ë‹ˆë‹¤.
## ë§ˆë¬´ë¦¬
ë™ê¸°í™” ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ SSEë¥¼ ì ìš©í•˜ê²Œ ëœ ë°°ê²½ê³¼ êµ¬í˜„ ë°©ë²•ì— ëŒ€í•´ ì•Œì•„ë³´ì•˜ìŠµë‹ˆë‹¤.

ë‹¤ì–‘í•œ ì˜ˆì™¸ ì²˜ë¦¬ì™€ ë°ì´í„° ì¼ê´€ì„± ë¬¸ì œ, ì¸í”„ë¼ êµ¬ì¡°ì— ë”°ë¥¸ íŠ¸ëŸ¬ë¸” ìŠˆíŒ… ë“± ë™ê¸°í™”ë¥¼ ì ìš©í•˜ëŠ” ê³¼ì •ì—ì„œ ì˜ˆìƒì¹˜ ëª»í•œ ë¬¸ì œê°€ ë°œìƒí•  ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤.

ì„œë¹„ìŠ¤ì˜ íŠ¹ì„±ìƒ SSEë¥¼ ì‚¬ìš©í• ì§€, ì›¹ì†Œì¼“ì„ ì‚¬ìš©í• ì§€, í˜¹ì€ ë™ê¸°í™”ë¥¼ ì ìš©í•  í•„ìš”ê°€ ì—†ëŠ”ì§€ ê¼¼ê¼¼í•˜ê²Œ ë¶„ì„í•œ ë’¤ ë™ê¸°í™”ë¥¼ ë„ì…í•˜ëŠ” ê²ƒì„ ì¶”ì²œí•©ë‹ˆë‹¤.
