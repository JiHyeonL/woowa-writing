# SSEë¡œ í”„ë¡œì íŠ¸ ê³ ë„í™” í•˜ê¸° - íƒ€ì´ë¨¸ ê¸°ëŠ¥ ë™ê¸°í™”

ì•ˆë…•í•˜ì„¸ìš”, ìš°ì•„í•œí…Œí¬ì½”ìŠ¤ 6ê¸° ë ˆëª¨ë„¤ ì…ë‹ˆë‹¤.
ìœ„ ì£¼ì œë¥¼ ì„ íƒí•˜ê²Œ ëœ ì´ìœ ëŠ”, ì œê°€ ì§„í–‰í•˜ê³  ìˆëŠ” í”„ë¡œì íŠ¸ì¸ â€œì½”ë”©í•´ë“€ì˜¤" ì—ì„œ SSEë¥¼ ì‚¬ìš©í•´ì„œ ê¸°ëŠ¥ì„ ê°œì„ í•œ ê²½í—˜ì„ ê³µìœ í•˜ê³  ì‹¶ì—ˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

ì €í¬ í”„ë¡œì íŠ¸ëŠ” â€œí˜ì–´ í”„ë¡œê·¸ë˜ë°ì— í•„ìš”í•œ ê¸°ëŠ¥(ì˜ˆ: íƒ€ì´ë¨¸, ë©”ëª¨ì¥)ì„ í•˜ë‚˜ì˜ ì„œë¹„ìŠ¤ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤ë©´ ì–¼ë§ˆë‚˜ í¸ë¦¬í• ê¹Œ?â€ ë¼ëŠ” ìƒê°ì—ì„œ ì¶œë°œí–ˆìŠµë‹ˆë‹¤. í˜¹ì‹œë¼ë„ í˜ì–´ í”„ë¡œê·¸ë˜ë°ì´ë¼ëŠ” ìš©ì–´ë¥¼ ì²˜ìŒ ë“¤ì–´ë³¸ ë¶„ë“¤ì´ ê³„ì‹¤ ìˆ˜ ìˆìœ¼ë‹ˆ í˜ì–´ í”„ë¡œê·¸ë˜ë°ë€ ë¬´ì—‡ì¸ì§€ ì§§ê²Œ ì†Œê°œí•´ ë“œë¦¬ê² ìŠµë‹ˆë‹¤. 
í˜ì–´ í”„ë¡œê·¸ë˜ë°ì€ â€œë„¤ë¹„ê²Œì´í„°â€ì™€ â€œë“œë¼ì´ë²„â€ ë‘ ì—­í• ë¡œ ë‚˜ë‰©ë‹ˆë‹¤.
ë¬¸ì œ í•´ê²° ë°©ë²•ì„ êµ¬ë‘ë¡œ ì„¤ëª…í•˜ëŠ” ë„¤ë¹„ê²Œì´í„°ì™€, ë„¤ë¹„ê²Œì´í„°ì˜ ì„¤ëª…ì— ë”°ë¼ ì½”ë“œë¥¼ ì‘ì„±í•˜ëŠ” ë“œë¼ì´ë²„ëŠ” íŠ¹ì • ì‹œê°„(ì˜ˆ: 10ë¶„) ë™ì•ˆ ìì‹ ì˜ ì—­í• ì„ ìˆ˜í–‰í•œ ë’¤ ë°˜ëŒ€ ì—­í• ë¡œ êµì²´í•©ë‹ˆë‹¤. 
ë‚´ê°€ 10ë¶„ë™ì•ˆ ë“œë¼ì´ë²„ ì—­í• ì„ ìˆ˜í–‰í–ˆë‹¤ë©´, 10ë¶„ ë’¤ì—ëŠ” ë„¤ë¹„ê²Œì´í„°ê°€ ë˜ëŠ” ê²ƒì´ì£ .

ì„œë¡ ì´ ê¸¸ì—ˆìŠµë‹ˆë‹¤. ì´ì œ ë³¸ê²©ì ìœ¼ë¡œ í”„ë¡œì íŠ¸ì— SSEë¥¼ ë„ì…í•˜ê²Œ ëœ ë°°ê²½ì„ ì•Œì•„ë³¼ê¹Œìš”?

## ë™ê¸°í™”ê°€ í•„ìš”í•´
ì €í¬ ì„œë¹„ìŠ¤ì—ì„œ â€œë°© ë§Œë“¤ê¸°" ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ í˜ì–´ í”„ë¡œê·¸ë˜ë°ì„ í•  ìˆ˜ ìˆëŠ” ê³µê°„ì„ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
![image](https://github.com/user-attachments/assets/85cf2dc2-6084-4190-b462-c59dcb97da07)

ì´ ê³µê°„ì„ â€œí˜ì–´ë£¸" ì´ë¼ê³  ë¶€ë¥´ê² ìŠµë‹ˆë‹¤.
ë§Œì•½ í•´ë‹¹ í˜ì–´ë£¸ì— í•œ ëª…ì˜ ì‚¬ìš©ìë§Œ ì ‘ì†í•˜ê³  ìˆë‹¤ë©´ ë¬¸ì œê°€ ë°œìƒí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
ê·¸ëŸ¬ë‚˜ í˜ì–´ë£¸ì— ì—¬ëŸ¬ ì‚¬ìš©ìê°€ ì ‘ì†í•˜ê²Œ ëœë‹¤ë©´ í° ë¬¸ì œê°€ ë°œìƒí•©ë‹ˆë‹¤.
ë°”ë¡œ íƒ€ì´ë¨¸ê°€ ë™ê¸°í™” ë˜ì§€ ì•ŠëŠ”ë‹¤ëŠ” ì ì´ì£ .
![image](https://github.com/user-attachments/assets/ef9ba964-7c8a-497e-a535-f2f5fd74e20f)

> ğŸ‹ ë ˆëª¨ë„¤: í˜ì–´ë£¸ ë§Œë“¤ì—ˆì–´! ì´ì œ íƒ€ì´ë¨¸ë¥¼ ì‹¤í–‰í•˜ê³  í˜ì–´ í”„ë¡œê·¸ë˜ë°ì„ ì‹œì‘í•˜ì.   
> ğŸ ì‚¬ê³¼: íƒ€ì´ë¨¸ë¥¼ ë‚´ ë…¸íŠ¸ë¶ìœ¼ë¡œë„ í™•ì¸í•˜ê³  ì‹¶ìœ¼ë‹ˆê¹Œ, ë ˆëª¨ë„¤ê°€ ë§Œë“  í˜ì–´ë£¸ì— ì ‘ì†í•´ì•¼ê² ë‹¤. ì–´, ê·¸ëŸ°ë° íƒ€ì´ë¨¸ í™”ë©´ì´ ë ˆëª¨ë„¤ì™€ ë‹¤ë¥´ë„¤?

ì´ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ì–´ë–¤ ê¸°ìˆ ì„ ì‚¬ìš©í•´ì•¼ í• ê¹Œìš”?
 
## ì›¹ì†Œì¼“ vs SSE
ë™ê¸°í™”ë¥¼ í•˜ë ¤ë©´ ì‹¤ì‹œê°„ìœ¼ë¡œ ë°ì´í„°ë¥¼ ì „ì†¡í•´ ì¤„ ë°©ë²•ì´ í•„ìš”í•œë°ìš”,
ê°€ì¥ ë§ì´ ì“°ì´ëŠ” ê¸°ìˆ ë¡œ ì›¹ì†Œì¼“ê³¼ SSE ê°€ ìˆìŠµë‹ˆë‹¤.
ë‘ ê¸°ìˆ ì„ ë¹„êµí•˜ë©° ì €í¬ ì„œë¹„ìŠ¤ì— ì–´ë–¤ ë°©ì‹ì´ ë” ì ì ˆí• ì§€ ì°¾ì•„ë´…ì‹œë‹¤.

### SSE (Server-Sent-Event)
SSEëŠ” http í”„ë¡œí† ì½œ ê¸°ë°˜ ì‹¤ì‹œê°„ í†µì‹  ë°©ë²•ì…ë‹ˆë‹¤.
SSEì˜ íŠ¹ì§•ì€ ë‹¨ë°©í–¥ í†µì‹ ì´ë¼ëŠ” ì ì¸ë°ìš”, ì„œë²„ì—ì„œ í´ë¼ì´ì–¸íŠ¸ë¡œ ì„œë²„ê°€ ì¼ë°©ì ìœ¼ë¡œ ë°ì´í„°ë¥¼ ì „ì†¡í•©ë‹ˆë‹¤. 
http í”„ë¡œí† ì½œ íŠ¹ì„±ìƒ ìš”ì²­-ì‘ë‹µ ì£¼ê¸°ê°€ ë°˜ë³µë˜ì–´ì•¼ í• í…ë°, ì–´ë–»ê²Œ ìš”ì²­ì´ ì—†ëŠ”ë°ë„ ì„œë²„ê°€ ì§€ì†ì ìœ¼ë¡œ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ë°ì´í„°ë¥¼ ì „ì†¡í•  ìˆ˜ ìˆì„ê¹Œìš”?
ì •ë‹µì€ ì„œë²„ê°€ ë³´ë‚´ëŠ” ë°ì´í„°ê°€ í•˜ë‚˜ì˜ ì‘ë‹µì´ ì•„ë‹Œ, chunk ë‹¨ìœ„ì˜ ìŠ¤íŠ¸ë¦¼ì´ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.


í´ë¼ì´ì–¸íŠ¸ê°€ SSE í†µì‹ ì„ ì‹œì‘í•  ê²ƒì´ë¼ëŠ” ì—°ê²° ìš”ì²­ì„ ë³´ë‚´ë©´, SSE ì»¤ë„¥ì…˜ì´ ìƒì„±ë©ë‹ˆë‹¤.
ê·¸ ë•Œë¶€í„° í•´ë‹¹ ì»¤ë„¥ì…˜ìœ¼ë¡œ ì„œë²„ê°€ ë°ì´í„°ë¥¼ ì „ì†¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ìœ„ì—ì„œ ë°ì´í„°ê°€ chunk ë‹¨ìœ„ë¡œ ì „ì†¡ëœë‹¤ëŠ” í‘œí˜„ì„ ì‚¬ìš©í–ˆëŠ”ë°ìš”, ê°„ë‹¨í•˜ê²Œ ë§í•˜ìë©´ â€œë°ì´í„°ë¥¼ ì‘ì€ ë‹¨ìœ„ë¡œ ìª¼ê°œì„œ ê³„ì† ë³´ë‚¼ê±°ì•¼. ì•„ì§ ë°ì´í„°ë¥¼ ë‹¤ ë³´ë‚´ì§€ ì•Šì•˜ìœ¼ë‹ˆ ì‘ë‹µì€ ëë‚˜ì§€ ì•Šì•˜ì–´!â€ ë¼ëŠ” ì˜ë¯¸ì…ë‹ˆë‹¤.
ê²°êµ­ í•˜ë‚˜ì˜ ìš”ì²­ì— í•˜ë‚˜ì˜ ì‘ë‹µì´ë¼ëŠ” íŠ¹ì„±ì€ ìœ ì§€í•œ ì±„, ë°ì´í„°ë¥¼ ì§€ì†ì ìœ¼ë¡œ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì „ì†¡í•  ìˆ˜ ìˆëŠ” ê²ƒì´ì£ .
ì»¤ë„¥ì…˜ì´ ëŠì–´ì§ˆ ë•Œê¹Œì§€ í´ë¼ì´ì–¸íŠ¸ëŠ” ì„œë²„ê°€ ë³´ë‚´ëŠ” ë°ì´í„°ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ëŸ¬í•œ íŠ¹ì§• ë•Œë¬¸ì— SSEëŠ” ì•Œë¦¼ ì‹œìŠ¤í…œì„ êµ¬ì¶•í•  ë•Œ ì£¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.
  
### ì›¹ì†Œì¼“
ì›¹ì†Œì¼“ì€ ì›¹ì†Œì¼“ í”„ë¡œí† ì½œ ê¸°ë°˜ ì‹¤ì‹œê°„ í†µì‹ ì…ë‹ˆë‹¤. http í”„ë¡œí† ì½œì´ ì•„ë‹Œ, ì›¹ì†Œì¼“ í”„ë¡œí† ì½œì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
SSEì™€ êµ¬ë¶„ë˜ëŠ” ê°€ì¥ í° íŠ¹ì§•ì€ ì–‘ë°©í–¥ í†µì‹ ì„ í•œë‹¤ëŠ” ì ì…ë‹ˆë‹¤.
ì–‘ë°©í–¥ í†µì‹ ì´ ê°€ëŠ¥í•˜ë‹¤ëŠ” ê²ƒì€, í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ê°€ ë™ì‹œì— ë°ì´í„°ë¥¼ ì£¼ê³ ë°›ì„ ìˆ˜ ìˆë‹¤ëŠ” ëœ»ì…ë‹ˆë‹¤.
http í”„ë¡œí† ì½œì—ì„œëŠ” í´ë¼ì´ì–¸íŠ¸ì˜ ìš”ì²­ì´ ì˜¬ ë•Œê¹Œì§€ ê¸°ë‹¤ë¦° ë’¤ ì‘ë‹µì„ ë³´ë‚´ê±°ë‚˜, ì„œë²„ì—ì„œ í´ë¼ì´ì–¸íŠ¸ ë°©í–¥ìœ¼ë¡œë§Œ ì§€ì†ì ìœ¼ë¡œ ë°ì´í„°ë¥¼ ë³´ë‚¼ ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.

ê·¸ëŸ¬ë‚˜ ì›¹ì†Œì¼“ì€ ì„œë²„ê°€ í´ë¼ì´ì–¸íŠ¸ì´ ìš”ì²­ ì—†ì´ ì‘ë‹µí•  ìˆ˜ë„ ìˆê³ , ì„œë²„ê°€ ì‘ë‹µí•˜ì§€ ì•Šì•„ë„ í´ë¼ì´ì–¸íŠ¸ê°€ ì—¬ëŸ¬ë²ˆ ìš”ì²­í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
ì‚¬ì‹¤ìƒ í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„, ìš”ì²­ê³¼ ì‘ë‹µì´ êµ¬ë³„ë˜ì§€ ì•ŠëŠ” ë™ë“±í•œ ìƒíƒœê°€ ë˜ëŠ” ê²ƒì´ì£ .

ê·¸ë˜ì„œ ì›¹ì†Œì¼“ì€ ì±„íŒ… ì• í”Œë¦¬ì¼€ì´ì…˜ì— ì£¼ë¡œ ì“°ì…ë‹ˆë‹¤.

## ê·¸ë˜ì„œ ì–´ë–¤ ê¸°ìˆ ì„ ì‚¬ìš©í• ê¹Œ?
ì§€ê¸ˆê¹Œì§€ SSEì™€ ì›¹ì†Œì¼“ì— ëŒ€í•´ ì•Œì•„ë³´ì•˜ìŠµë‹ˆë‹¤.
ì´ì œ ì–´ë–¤ ë°©ì‹ì„ ì„ íƒí• ì§€ ê²°ì •í•  ì‹œê°„ì´ ë˜ì—ˆë„¤ìš”.

íƒ€ì´ë¨¸ë¥¼ ë™ê¸°í™” í•  ë•Œ ì–´ë–¤ ì •ë³´ê°€ í•„ìš”í•œì§€ ìƒê°í•´ ë´…ì‹œë‹¤.
íƒ€ì´ë¨¸ ì‹œì‘ ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ, íƒ€ì´ë¨¸ ì‹œê°„ì´ 1ì´ˆì”© ì¤„ì–´ë“ ë‹¤. 
íƒ€ì´ë¨¸ ì¤‘ë‹¨ ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ, íƒ€ì´ë¨¸ ì‹œê°„ì´ íë¥´ì§€ ì•ŠëŠ”ë‹¤.

íƒ€ì´ë¨¸ ì‹œì‘ ìš”ì²­ì„ ë³´ëƒˆì„ ë•Œ, 1ì´ˆì”© ì¤„ì–´ë“œëŠ” ì‹œê°„ ì •ë³´ë§Œ í•„ìš”í•˜ë‹¤ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
íƒ€ì´ë¨¸ ì‹œê°„ì„ ì„œë²„ê°€ ê´€ë¦¬í•œë‹¤ëŠ” ê°€ì • í•˜ì—, ì„œë²„ê°€ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ íƒ€ì´ë¨¸ê°€ ì¢…ë£Œë˜ê¸°ê¹Œì§€ ë‚¨ì€ ì‹œê°„ì„ 1ì´ˆë§ˆë‹¤ ì „ì†¡í•´ ì£¼ë©´ ë˜ê² ë„¤ìš”.

ê·¸ëŸ¼ ì—¬ê¸°ì„œ ë– ì˜¤ë¥´ëŠ” ê¸°ìˆ ì´ í•˜ë‚˜ ìˆì„ í…ë°ìš”, ë°”ë¡œ SSE ì…ë‹ˆë‹¤.
ì›¹ì†Œì¼“ì´ ì œê³µí•˜ëŠ” ì–‘ë°©í–¥ í†µì‹ ì´ë¼ëŠ” ì´ì ì´ íƒ€ì´ë¨¸ ë™ê¸°í™”ì— í•„ìˆ˜ì ì´ì§€ ì•Šê¸° ë•Œë¬¸ì— SSEë¥¼ ì‚¬ìš©í•˜ëŠ”ê²Œ ë” ì ì ˆí•´ ë³´ì…ë‹ˆë‹¤. 

ì´ì œ ë³¸ê²©ì ìœ¼ë¡œ êµ¬í˜„ì„ ì‹œì‘í•´ ë´…ì‹œë‹¤.

## 1ì´ˆë§ˆë‹¤ ì‚¬ìš©ìì—ê²Œ íƒ€ì´ë¨¸ ì‹œê°„ ì „ì†¡í•˜ê¸°
â€œì½”ë”©í•´ë“€ì˜¤â€ëŠ” spring bootë¥¼ ì‚¬ìš©í•˜ê³  ìˆê¸° ë•Œë¬¸ì— spring bootë¥¼ ê¸°ë°˜ìœ¼ë¡œ SSEë¥¼ êµ¬í˜„í•´ ë³´ê² ìŠµë‹ˆë‹¤.

### 1 - ì»¤ë„¥ì…˜ ìƒì„±
ë¨¼ì € í˜ì–´ë£¸ì— ì ‘ì†í•œ í´ë¼ì´ì–¸íŠ¸ì™€ SSE ì»¤ë„¥ì…˜ì„ ë§ºì–´ì•¼ í•©ë‹ˆë‹¤.

``` java
@RestController
public class SseController implements SseDocs {


   private final SseService sseService;


   @GetMapping("/{key}/connect")
   public ResponseEntity<SseEmitter> createConnection(@PathVariable("key") final String key) {
       final SseEmitter sseEmitter = sseService.connect(key);


       return ResponseEntity.ok(sseEmitter);
   }
```
ì»¨íŠ¸ë¡¤ëŸ¬ì— SSE ì»¤ë„¥ì…˜ ìƒì„± ìš”ì²­ apië¥¼ ì¶”ê°€í•´ ì¤ì‹œë‹¤.
ì°¸ê³ ë¡œ ì—”íŠ¸í¬ì¸íŠ¸ì— ìˆëŠ” `{key}`ëŠ” í˜ì–´ë£¸ì„ ì‹ë³„í•  ìˆ˜ ìˆëŠ” ì½”ë“œì…ë‹ˆë‹¤.

`sseService.connect()` ê°€ ì–´ë–»ê²Œ êµ¬í˜„ë˜ì–´ ìˆëŠ”ì§€ ìì„¸íˆ ì‚´í´ë´…ì‹œë‹¤.

``` java
@Service
public class SseService {


   private final EventStreamsRegistry eventStreamsRegistry;


   public SseEmitter connect(final String key) {
       final SseEmitter emitter = eventStreamsRegistry.register(key);
       return emitter;
   }
```
eventStreamRegistryì—ì„œ key(í˜ì–´ë£¸ ì‹ë³„ì)ì— í•´ë‹¹í•˜ëŠ” SseEmitterë¥¼ ìƒì„±í•˜ê³ , í•´ë‹¹ SseEmitterë¥¼ ë°˜í™˜í•˜ê³  ìˆìŠµë‹ˆë‹¤.
SseEmitterëŠ” SSE ë¥¼ êµ¬í˜„í•  ìˆ˜ ìˆë„ë¡ ìŠ¤í”„ë§ì´ ì œê³µí•˜ëŠ” í´ë˜ìŠ¤ë¡œ ì´ ê°ì²´ë¥¼ í†µí•´ ë°ì´í„°ë¥¼ ì „ì†¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. SseEmitterë¥¼ ê°„ë‹¨í•˜ê²Œ ë§í•˜ë©´, í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ë°ì´í„°ë¥¼ ì „ì†¡í•˜ê¸° ìœ„í•œ ì»¤ë„¥ì…˜ì´ë¼ê³  í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
êµ¬ì²´ì ìœ¼ë¡œ ì–´ë–¤ ì¼ì„ í•˜ëŠ”ì§€ëŠ” ë’¤ì—ì„œ ìì„¸í•˜ê²Œ ì„¤ëª…í•˜ê² ìŠµë‹ˆë‹¤.

EventStreamRegistryë¥¼ ì‚´í´ë´…ì‹œë‹¤.

``` java
@Component
public class EventStreamsRegistry {


   private final Map<String, EventStreams> registry;


   public EventStreamsRegistry() {
       this.registry = new ConcurrentHashMap<>();
   }


   public SseEmitter register(final String key) {
       final EventStreams eventStreams = registry.getOrDefault(key, new EventStreams());
       final EventStream eventStream = new SseEventStream();
       eventStreams.add(eventStream);
       registry.put(key, eventStreams);
       return eventStreams.publish(eventStream);
   }
 ```
register ë©”ì„œë“œëŠ” í˜ì–´ë£¸ ì‹ë³„ìë¥¼ keyë¡œ ê°–ê³ ìˆëŠ” EventStreamsì— ìƒˆë¡œìš´ EventStreamì„ ìƒì„±í•˜ì—¬ ì¶”ê°€í•©ë‹ˆë‹¤. 
EventStreamì€ SseEmitterë¥¼ ìƒì„±í•˜ê³ , SseEmitterë¥¼ í†µí•´ ë°ì´í„°ë¥¼ ì „ì†¡í•˜ëŠ” ì—­í• ì„ ë§¡ê³  ìˆëŠ” ì¸í„°í˜ì´ìŠ¤ì…ë‹ˆë‹¤.
EventStreamsëŠ” List<EventStream>ë¥¼ ë©¤ë²„ ë³€ìˆ˜ë¡œ ê°–ê³ ìˆëŠ” ì¼ê¸‰ ì»¬ë ‰ì…˜ì…ë‹ˆë‹¤.
í•˜ë‚˜ì˜ í˜ì–´ë£¸ì— ì—¬ëŸ¬ëª…ì˜ ì‚¬ìš©ìê°€ ì¡´ì¬í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— EventStreamì´ ì•„ë‹Œ List<EventStream>ì„ ê°’ìœ¼ë¡œ ê°–ê³  ìˆìŠµë‹ˆë‹¤.

EventStreamsì— ëŒ€í•´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.

``` java
public class EventStreams {


   private final List<EventStream> streams = new CopyOnWriteArrayList<>();


   public SseEmitter publish(final EventStream eventStream) {
       final SseEmitter sseEmitter = eventStream.connect();
       sseEmitter.onTimeout(sseEmitter::complete);
       sseEmitter.onCompletion(() -> streams.remove(eventStream));
       sseEmitter.onError(error -> streams.remove(eventStream));
       return sseEmitter;
   }
```
EventStreamì€ SseEmitterë¥¼ ìƒì„±í•˜ê³ , í•´ë‹¹ SseEmitterê°€ íƒ€ì„ì•„ì›ƒ ë˜ì—ˆì„ ë•Œ, ì¢…ë£Œë˜ì—ˆì„ ë•Œ, ì—ëŸ¬ê°€ ë°œìƒí–ˆì„ ë•Œ, ì–´ë–¤ í–‰ë™ì„ í• ì§€ ì½œë°± í•¨ìˆ˜ë¥¼ ë“±ë¡í•©ë‹ˆë‹¤. ì½”ë“œì—ì„œëŠ” ìœ„ì˜ ì„¸ê°€ì§€ ìƒí™©ì´ ë°œìƒí–ˆì„ ë•Œ streamsì—ì„œ í•´ë‹¹ EventStreamì„ ì‚­ì œí•©ë‹ˆë‹¤.

EventStreamì˜ êµ¬í˜„ì²´ì¸ SseEventStreamì— ëŒ€í•´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.
``` java
public class SseEventStream implements EventStream {


   private static final Duration TIME_OUT = Duration.ofMinutes(20);
   private static final String CONNECT_NAME = "connect";
   private static final String SUCCESS_MESSAGE = "OK";


   private final AtomicLong id = new AtomicLong(0);
   private final SseEmitter sseEmitter;


   public SseEventStream() {
       this.sseEmitter = new SseEmitter(TIME_OUT.toMillis());
   }


   @Override
   public SseEmitter connect() {
       final String eventId = String.valueOf(id.incrementAndGet());
       try {
           sseEmitter.send(SseEmitter.event()
                   .id(eventId)
                   .name(CONNECT_NAME)
                   .data(SUCCESS_MESSAGE));
       } catch (final IOException e) {
           sseEmitter.complete();
           throw new SseConnectionFailureException("SSE ì—°ê²°ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
       }
       return sseEmitter;
   }
```
ê¸°ë³¸ì ìœ¼ë¡œ SseEmitterì˜ íƒ€ì„ì•„ì›ƒ ì‹œê°„ì€ 20ë¶„ì…ë‹ˆë‹¤. 20ë¶„ ë’¤ì— SseEmitterëŠ” ì¢…ë£Œë˜ê³ , SSE ì—°ê²°ì´ ëŠì–´ì§€ê²Œ ë©ë‹ˆë‹¤.
connect ë©”ì„œë“œë¥¼ ì‚´í´ë³´ë©´, ì»¤ë„¥ì…˜ ì—°ê²°ì´ ì„±ê³µí–ˆì„ ì‹œ nameì€ â€œconnectâ€ë¡œ, dataëŠ” â€œOKâ€ê°€ ì „ì†¡ë©ë‹ˆë‹¤.
ê°œë°œì ë„êµ¬ë¥¼ ì—´ì–´ ë„¤íŠ¸ì›Œí¬ ì°½ì˜ EventStreamì„ í™•ì¸í•˜ë©´ ì•„ë˜ì™€ ê°™ì€ í™”ë©´ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![image](https://github.com/user-attachments/assets/7ec3aade-bdb2-40be-910d-fb9422b68fe3)
 
SSE ì»¤ë„¥ì…˜ì„ ë§ºëŠ” ê²ƒì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤.
ì´ì œ íƒ€ì´ë¨¸ë¥¼ ì‹œì‘í•´ ë´…ì‹œë‹¤.
### 2 - íƒ€ì´ë¨¸ ì‹œì‘
``` java
@RestController
public class TimerController implements TimerDocs {


   private final SchedulerService schedulerService;


   @PatchMapping("/{accessCode}/timer/start")
   public ResponseEntity<Void> createTimerStart(@PathVariable("accessCode") final String accessCode) {
       schedulerService.start(accessCode);
       return ResponseEntity.noContent()
               .build();
   }
```
ì»¨íŠ¸ë¡¤ëŸ¬ì— íƒ€ì´ë¨¸ ì‹œì‘ ìš”ì²­ apië¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
accessCodeëŠ” í˜ì–´ë£¸ ì‹ë³„ìë¥¼ ëœ»í•©ë‹ˆë‹¤. SSE ì»¤ë„¥ì…˜ì„ ë§ºì„ ë•Œ ì‚¬ìš©ë˜ì—ˆë˜ keyì™€ ê°™ìŠµë‹ˆë‹¤.

SchedulerServiceë¥¼ ì‚´í´ë´…ì‹œë‹¤.
``` java
@Component
public class SchedulerService {


   public static final Duration DELAY_SECOND = Duration.of(1, ChronoUnit.SECONDS);


   private final ThreadPoolTaskScheduler taskScheduler;
   private final SchedulerRegistry schedulerRegistry;
   private final TimestampRegistry timestampRegistry;
   private final TimerRepository timerRepository;
   private final SseService sseService;


   public void start(final String key) {
       if (isInitial(key)) {
           final Timer timer = timerRepository.fetchTimerByAccessCode(key)
                   .toDomain();
           scheduling(key, timer);
           timestampRegistry.register(key, timer);
           return;
       }
       final Timer timer = timestampRegistry.get(key);
       scheduling(key, timer);
   }


   private boolean isInitial(final String key) {
       return !schedulerRegistry.has(key) && !timestampRegistry.has(key);
   }


   private void scheduling(final String key, final Timer timer) {
       final Trigger trigger = new PeriodicTrigger(DELAY_SECOND);
       final ScheduledFuture<?> schedule = taskScheduler.schedule(() -> runTimer(key, timer), trigger);
       schedulerRegistry.register(key, schedule);
   }


   private void runTimer(final String key, final Timer timer) {
       if (timer.isTimeUp()) {
           stop(key);
           final Timer initalTimer = new Timer(timer.getAccessCode(), timer.getDuration(), timer.getDuration());
           timestampRegistry.register(key, initalTimer);
           return;
       }
       if (sseService.hasNoConnections(key)) {
           stop(key);
           return;
       }
       timer.decreaseRemainingTime(DELAY_SECOND.toMillis());
       sseService.broadcast(key, "remaining-time", String.valueOf(timer.getRemainingTime()));
   }
```
start ë©”ì„œë“œì—ì„œëŠ” ë¨¼ì € íƒ€ì´ë¨¸ê°€ ì‹¤í–‰ë˜ì—ˆë‹¤ê°€ ì¤‘ë‹¨ëœ ìƒíƒœì¸ì§€, ì•„ë‹ˆë©´ í•œë²ˆë„ ì‹¤í–‰ë˜ì§€ ì•Šì€ ìƒíƒœì¸ì§€ë¥¼ êµ¬ë¶„í•©ë‹ˆë‹¤. 
êµ¬ë¶„í•˜ëŠ” ì´ìœ ëŠ”, íƒ€ì´ë¨¸ ì´ ì‹œê°„ì€ dbì—ì„œ ê´€ë¦¬í•˜ì§€ë§Œ, íƒ€ì´ë¨¸ê°€ 1ì´ˆì”© ì¤„ì–´ë“  ìƒíƒœ, ì¦‰ íƒ€ì´ë¨¸ ë‚¨ì€ ì‹œê°„ì€ ì¸ë©”ëª¨ë¦¬ë¡œ ê´€ë¦¬í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. íƒ€ì´ë¨¸ ë‚¨ì€ ì‹œê°„ì´ ë³€ê²½ë  ë•Œë§ˆë‹¤ dbì— ì—…ë°ì´íŠ¸ í•  ìˆ˜ ì—†ê¸° ë•Œë¬¸ì— íƒ€ì´ë¨¸ ë‚¨ì€ ì‹œê°„ì€ TimeStampRegistryì—ì„œ ê´€ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤.

íƒ€ì´ë¨¸ê°€ í•œë²ˆë„ ì‹¤í–‰ë˜ì§€ ì•Šì€ ìƒíƒœë¼ë©´ dbì—ì„œ íƒ€ì´ë¨¸ ì‹œê°„ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.(íƒ€ì´ë¨¸ ì´ˆê¸°í™” ìƒíƒœ) íƒ€ì´ë¨¸ê°€ ì‹¤í–‰ë˜ì—ˆë˜ ì ì´ ìˆë‹¤ë©´, TimeStampRegistryì—ì„œ íƒ€ì´ë¨¸ í˜„ì¬ ì‹œê°„ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
ì´ ì‹œê°„ì„ ì´ìš©í•´ ìŠ¤ì¼€ì¤„ë§ì„ ì‹œì‘í•©ë‹ˆë‹¤.

1ì´ˆì— í•œë²ˆì”© íƒ€ì´ë¨¸ ë‚¨ì€ ì‹œê°„ì„ ì „ì†¡í•´ì•¼ í•˜ê¸° ë•Œë¬¸ì— ìŠ¤ì¼€ì¤„ëŸ¬ ì‹¤í–‰ ì£¼ê¸°ëŠ” 1ì´ˆë¡œ ì„¤ì •í–ˆìŠµë‹ˆë‹¤.
ThreadPoolTaskSchedulerë¥¼ í™œìš©í•´ 1ì´ˆì— í•œë²ˆì”© runTimerê°€ ì‹¤í–‰ë©ë‹ˆë‹¤.

runTimerì—ì„œëŠ” íƒ€ì´ë¨¸ ë‚¨ì€ ì‹œê°„ì„ 1ì´ˆ ì¤„ì´ê³ , í˜ì–´ë£¸ì— ìˆëŠ” ëª¨ë“  í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ë‚¨ì€ ì‹œê°„ì„ ì „ì†¡í•©ë‹ˆë‹¤.
íƒ€ì´ë¨¸ ë‚¨ì€ ì‹œê°„ì´ 0ì´ˆê°€ ëœë‹¤ë©´(íƒ€ì´ë¨¸ê°€ í•œë°”í€´ ëŒì•˜ì„ ë•Œ), íƒ€ì´ë¨¸ë¥¼ ì¤‘ë‹¨í•˜ê³  íƒ€ì´ë¨¸ ë‚¨ì€ ì‹œê°„ì„ íƒ€ì´ë¨¸ ì´ ì‹œê°„ìœ¼ë¡œ ì´ˆê¸°í™” í•©ë‹ˆë‹¤.
í˜ì–´ë£¸ì— ì‚¬ìš©ìê°€ ì•„ë¬´ë„ ì—†ì„ ê²½ìš°ì—ë„ íƒ€ì´ë¨¸ë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤.
íƒ€ì´ë¨¸ë¥¼ ì¤‘ë‹¨í•˜ëŠ” stop ë©”ì„œë“œëŠ” íƒ€ì´ë¨¸ ì¢…ë£Œ ëª©ì°¨ì—ì„œ ì„¤ëª…ë“œë¦¬ê² ìŠµë‹ˆë‹¤.

ì´ì œ íƒ€ì´ë¨¸ë¥¼ ì‹œì‘í•˜ë©´,
![image](https://github.com/user-attachments/assets/cc13643f-594d-4360-bcc3-154ec1e65d36)


ìœ„ ì‚¬ì§„ê³¼ ê°™ì€ ê²°ê³¼ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
ì‚¬ì§„ì— ìˆëŠ” íƒ€ì´ë¨¸ ì‹œê°„ì€ ë°€ë¦¬ì´ˆ ê¸°ì¤€ìœ¼ë¡œ, íƒ€ì´ë¨¸ ì‹œê°„ì´ 1000ë°€ë¦¬ì´ˆ(1ì´ˆ)ì”© ì¤„ì–´ë“¤ê³  ìˆëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
3 - íƒ€ì´ë¨¸ ì¢…ë£Œ

ì´ì œ ì‹¤í–‰ì¤‘ì¸ íƒ€ì´ë¨¸ë¥¼ ì¤‘ì§€í•´ ë´…ì‹œë‹¤.
ì´ì „ ë‹¨ê³„ì™€ ë§ˆì°¬ê°€ì§€ë¡œ íƒ€ì´ë¨¸ ì¤‘ì§€ apië¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
``` java
@PatchMapping("/{accessCode}/timer/stop")
public ResponseEntity<Void> createTimerStop(@PathVariable("accessCode") final String accessCode) {
   schedulerService.pause(accessCode);


   return ResponseEntity.noContent()
           .build();
}
```
schedulerService.pause ë©”ì„œë“œë¥¼ ì‚´í´ë´…ì‹œë‹¤.
``` java
public void pause(final String key) {
   sseService.broadcast(key, "timer", "pause");
   schedulerRegistry.release(key);
}
```
í˜ì–´ë£¸ì— ìˆëŠ” ëª¨ë“  ì‚¬ìš©ìì—ê²Œ íƒ€ì´ë¨¸ê°€ ì¤‘ì§€ë˜ì—ˆë‹¤ëŠ” ë°ì´í„°ë¥¼ ì „ì†¡í•©ë‹ˆë‹¤.
ê·¸ í›„, SchedulerRegistryì—ì„œ íƒ€ì´ë¨¸ë¥¼ ì¤‘ë‹¨í•˜ê³ ì í•˜ëŠ” í˜ì–´ë£¸ì˜ ìŠ¤ì¼€ì¤„ëŸ¬ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.
``` java
@Component
public class SchedulerRegistry {


   private final Map<String, ScheduledFuture<?>> registry;


   public SchedulerRegistry() {
       this.registry = new ConcurrentHashMap<>();
   }


   public void register(final String key, final ScheduledFuture<?> future) {
       registry.put(key, future);
   }


   public void release(final String key) {
       if (!registry.containsKey(key)) {
           throw new NotFoundScheduledFutureException("í‚¤ì— í•´ë‹¹í•˜ëŠ” ìŠ¤ì¼€ì¤„ëŸ¬ ê²°ê³¼ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
       }
       registry.get(key)
               .cancel(false);
       registry.remove(key);
   }
```
SchedulerRegistryëŠ” í˜ì–´ë£¸ ë³„ ìŠ¤ì¼€ì¤„ë§ ê²°ê³¼ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.
release ë©”ì„œë“œë¥¼ ì‚´í´ë³´ë©´, registryì—ì„œ í˜ì–´ë£¸ì„ keyë¡œ í˜ì–´ë£¸ ê²°ê³¼ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
ScheduledFutureëŠ” ìŠ¤ì¼€ì¤„ëŸ¬ì˜ í˜„ì¬ ìƒíƒœë¥¼ ë‚˜íƒ€ë‚´ëŠ” ê°ì²´ì…ë‹ˆë‹¤.
ScheduledFutureë¥¼ cancelí•˜ì—¬ ì‹¤í–‰ì¤‘ì´ë˜ ìŠ¤ì¼€ì¤„ëŸ¬ë¥¼ ì¢…ë£Œí•˜ê³ , registryì—ì„œ í•´ë‹¹ ScheduledFutureë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.

![image](https://github.com/user-attachments/assets/6debba45-a0a2-405f-93d2-8c93a653fcd3)


ì„±ê³µì ìœ¼ë¡œ íƒ€ì´ë¨¸ê°€ ì¤‘ë‹¨ë˜ë©´, 1ì´ˆë§ˆë‹¤ ì „ì†¡ë˜ë˜ íƒ€ì´ë¨¸ ë‚¨ì€ ì‹œê°„ì´ ë”ì´ìƒ ì „ì†¡ë˜ì§€ ì•Šê³ , timer pause ë©”ì„¸ì§€ê°€ ì „ì†¡ë©ë‹ˆë‹¤.
